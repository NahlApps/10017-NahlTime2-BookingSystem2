<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حجوزات المواعيد</title>

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      /* Brand */
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --ink-700:#224652; --surface-000:#FFF; --surface-100:#EDF3F6; --border-300:#D4E0E6;

      /* Radius + Shadow */
      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 6px rgba(11,38,48,.07);
      --shadow-sm:0 3px 12px rgba(11,38,48,.09);
      --shadow-md:0 10px 28px rgba(11,38,48,.14);

      /* Motion tokens */
      --ease:cubic-bezier(.22,.61,.36,1);
      --ease-decel:cubic-bezier(0.2,0,0,1);
      --ease-accel:cubic-bezier(0.3,1,0.8,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms; --dur-lg:640ms;

      /* Typography + spacing */
      --fs-xxl:1.6rem; --fs-xl:1.375rem; --fs-md:1rem; --fs-sm:.9rem; --fw-bold:800;
      --sp-2:8px; --sp-3:12px; --sp-4:16px; --sp-5:20px; --sp-6:24px; --sp-7:32px;

      /* Layout (auto-set by ResizeObserver) */
      --header-h:76px; --footer-h:100px;

      /* Background per page */
      --page-bg:url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG1.jpg");
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34)),
        var(--page-bg) center/cover no-repeat fixed;
      min-height:100vh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
      /* iOS: avoid jump on address bar show/hide */
      min-height:100dvh;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(11,38,48,.36); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .header-inner{
      max-width:1120px; width:100%; padding:10px var(--sp-3);
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:84px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}

    .header-right{flex:1; display:flex; flex-direction:column; gap:6px}
    .mini-progress{display:flex; align-items:center; gap:var(--sp-3); width:100%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease-decel)}
    .mini-progress .step{font-weight:var(--fw-bold); font-size:var(--fs-md)}

    /* Summary chips under progress */
    .summary-chips{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid rgba(255,255,255,.35);
      border-radius:999px; color:#fff; font-size:.85rem; background:transparent;
      max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chip i{opacity:.9}
    .chip .title{opacity:.85}
    .chip .value{font-weight:700}
    .chip.current{
      background:rgba(255,255,255,.18);
      border-color:rgba(255,255,255,.75);
      box-shadow:0 0 0 2px rgba(255,255,255,.16) inset;
    }

    /* Main/stage/pages */
    main{flex:1 0 auto; display:flex; justify-content:center; padding:var(--sp-2) var(--sp-3) 0}
    #app{width:100%; max-width:1120px}
    .stage{position:relative; min-height:560px; padding:8px 0 20px}
    .page{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:var(--sp-5);
      padding:var(--sp-5) var(--sp-3) var(--sp-6); overflow:auto; opacity:0; transform:translateY(12px) scale(.992);
      pointer-events:none;
    }
    .page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease-decel) both; }
    .page.exit  { animation:pageOut var(--dur-sm) var(--ease-accel) both; }
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{font-size:var(--fs-xl); font-weight:var(--fw-bold); margin:0; text-align:center}

    /* Cards (semi-transparent to show background) */
    .card{
      background:rgba(255,255,255,.88); color:var(--ink-900);
      border-radius:var(--radius-md); box-shadow:var(--shadow-md);
      padding:var(--sp-6); width:100%; max-width:920px; backdrop-filter:blur(6px);
    }

    /* Form + Select2 (contrast) */
    .form-control, select, .select2-selection{
      background:#fff; color:#0B2630;
      border:1px solid var(--border-300) !important; border-radius:var(--radius-md)!important;
      min-height:52px; text-align:center; font-size:16px; /* 16px to avoid iOS zoom */
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .form-control:focus{ box-shadow:0 0 0 4px rgba(2,122,147,.12) }
    .form-label{display:inline-block; margin-bottom:6px; font-size:var(--fs-sm); font-weight:var(--fw-bold); color:#224652}
    .field-error{color:#dc2626; font-size:.85rem; margin-top:6px; display:none}
    .has-error .form-control, .has-error .select2-selection{ border-color:#dc2626 !important; }
    .has-error .field-error{display:block}

    .select2-container .select2-selection--single .select2-selection__rendered{color:#0B2630!important; line-height:52px!important;}
    .select2-container .select2-selection--single{height:52px!important; display:flex; align-items:center}
    .select2-dropdown{background:#fff; color:#0B2630}
    .select2-results__option, .select2-search__field{color:#0B2630}
    .select2-container--open .select2-dropdown{border:1px solid var(--border-300); box-shadow:var(--shadow-sm); overflow:hidden; transform-origin:top center; animation:dropdownIn var(--dur-sm) var(--ease-decel) both;}
    @keyframes dropdownIn{ from{opacity:0; transform:translateY(6px) scale(.99)} to{opacity:1; transform:none} }

    /* Time grid */
    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:var(--sp-4)}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{
      background:#fff; color:#0B2630; font-weight:var(--fw-bold);
      border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:14px 10px; min-height:64px; box-shadow:var(--shadow-xs);
      transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .time-option:hover{transform:translateY(-2px); background:var(--brand-050); box-shadow:var(--shadow-sm)}
    .time-option:active{transform:translateY(0) scale(.995)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Overlays (service + time loaders) */
    .load-overlay{
      position:absolute; inset:0; background:rgba(255,255,255,.88);
      color:#0B2630; display:none; align-items:center; justify-content:center; gap:12px; border-radius:var(--radius-md);
      backdrop-filter:blur(2px);
    }
    .load-overlay.show{display:flex; animation:fadeIn var(--dur-sm) var(--ease) both}
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* Payment page */
    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--sp-4); width:100%; max-width:920px}
    .pay-card{
      background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:var(--radius-md);
      padding:var(--sp-6); display:flex; justify-content:center; align-items:center; gap:var(--sp-4);
      min-height:76px; cursor:pointer; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .pay-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm); background:var(--brand-050)}
    .pay-card:active{transform:translateY(0) scale(.995)}
    .pay-card img{max-width:140px; height:auto}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    /* Map */
    #googleMap{width:100%;height:420px;border-radius:14px;overflow:hidden}

    /* Footer (bigger on mobile) */
    footer.sticky-nav{
      position:sticky; bottom:0; z-index:40; background:rgba(11,38,48,.45);
      backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.15);
    }
    .footer-inner{ max-width:1120px; width:100%; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .footer-brand{ font-size:.95rem; color:#fff; opacity:.94; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .footer-brand a{color:#fff; text-decoration:underline}
    .footer-social{display:flex; align-items:center; gap:12px}
    .footer-social a{color:#fff; opacity:.95; font-size:1.2rem}
    .footer-actions{display:flex; gap:12px}
    .btn-footer{ flex:1; border:1px solid var(--border-300); border-radius:var(--radius-md); padding:16px 16px; min-height:56px; font-size:var(--fs-md); font-weight:var(--fw-bold); background:#fff; color:#027A93; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease), color var(--dur-xs) var(--ease), border-color var(--dur-xs) var(--ease); }
    .btn-footer:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm)}
    .btn-footer:active{transform:translateY(0) scale(.995)}
    .btn-footer.primary{background:#027A93; color:#fff; border-color:#027A93}
    .btn-footer.hidden{visibility:hidden}
    .btn-footer.disabled, .btn-footer:disabled{opacity:.6; pointer-events:none}

    /* Mobile polish */
    @media (max-width: 480px){
      :root{ --footer-h: 118px; }
      .header-inner{
        padding-top: max(8px, env(safe-area-inset-top));
        padding-bottom: 8px;
        gap: 10px;
      }
      .brand img{ height: 72px }
      .summary-chips{ gap: 4px }
      .summary-chips .chip{ padding: 5px 9px; font-size: .82rem; }
      .btn-footer{min-height:58px; font-size:1.05rem}
      .footer-inner{flex-wrap:wrap}
      .footer-actions{width:100%}
      .footer-brand{width:100%; justify-content:space-between}
    }

    /* Tel input RTL: keep flag clear */
    html[dir="rtl"] .iti--allow-dropdown .iti__flag-container{ right: 8px; left: auto; }
    html[dir="rtl"] .iti--allow-dropdown input#mobile.form-control{
      padding-right: calc(76px + 8px);
      padding-left: 12px;
    }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastWrap" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050;display:flex;flex-direction:column;gap:8px"></div>

  <!-- Header -->
  <header id="siteHeader">
    <div class="header-inner">
      <!-- Brand (no frame) -->
      <div class="brand">
        <img id="brandLogo"
             alt="Nahl Time"
             src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/ChatGPT%20Image%20Sep%2013,%202025,%2001_21_33%20PM.png"
             onerror="handleLogoError(this)" />
      </div>

      <!-- Progress + chips -->
      <div class="header-right">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">الترحيب</div>
        </div>
        <div id="summaryChips" class="summary-chips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome (your adjusted PPT can live here if desired) -->
        <section id="page1" class="page active" aria-label="الترحيب">
          <h1>✨ غسيل بدون طوابير</h1>
          <div class="card text-center" style="max-width:860px">
            <p class="mb-0" style="color:#224652">نجيك لين باب بيتك — جودة وفخامة بالتفاصيل الصغيرة</p>
          </div>
        </section>

        <!-- 2) Service & Location (with spinner) -->
        <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
          <h1>وين تحب نجيك؟</h1>

          <div class="card position-relative" id="servicesCard">
            <label class="form-label">اختيار المنطقة</label>
            <select id="area" class="js-example-basic-single" style="width:100%"></select>
            <div class="field-error" id="err-area">يرجى اختيار المنطقة</div>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">التصنيف</label>
                <select id="serviceCat" style="width:100%"></select>
                <div class="field-error" id="err-serviceCat">يرجى اختيار التصنيف</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الخدمة</label>
                <select id="service" style="width:100%"></select>
                <div class="field-error" id="err-service">يرجى اختيار الخدمة</div>
              </div>
              <div class="col-12">
                <label class="form-label">عدد السيارات</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <!-- Spinner only for services load -->
            <div id="servicesLoading" class="load-overlay" aria-hidden="true">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>جاري تحميل الخدمات…</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page3" class="page" aria-label="اختيار الموعد">
          <h1>متى تحب نجيك؟</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">التاريخ</label>
                <input id="date" type="date" class="form-control"/>
                <div class="field-error" id="err-date">يرجى اختيار تاريخ صحيح</div>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="اختيار الوقت"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>جاري جلب المواعيد…</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page4" class="page" aria-label="معلومات الاتصال">
          <h1>معلومات الاتصال</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6 form-block">
                <label for="name" class="form-label">الإسم</label>
                <input id="name" type="text" class="form-control" placeholder="اسمك الكريم" autocomplete="name"/>
                <div class="field-error" id="err-name">يرجى إدخال الاسم</div>
              </div>
              <div class="col-12 col-md-6 form-block">
                <label for="mobile" class="form-label">رقم الجوال</label>
                <input id="mobile" type="tel" class="form-control" placeholder="+9665…" autocomplete="tel"/>
                <div class="field-error" id="err-mobile">الرجاء إدخال رقم جوال صحيح</div>
              </div>
            </div>
          </div>

          <h1>معلومات المركبة</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">ماركة السيارة 🚘</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">اسم السيارة</label>
                <input id="carName" type="text" class="form-control" placeholder="كامري، إلنترا…" autocomplete="off"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">آخر 4 أرقام من اللوحة</label>
                <input id="plateNumber" type="text" inputmode="numeric" maxlength="4" class="form-control" placeholder="1234" autocomplete="off"/>
                <small id="plateHelp" class="text-muted d-block mt-1" style="opacity:.9">نستخدم آخر ٤ أرقام للتأكيد فقط</small>
                <div class="field-error" id="err-plate" style="display:none"></div>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>
        </section>

        <!-- 5) Payment (separate page) -->
        <section id="page5" class="page" aria-label="طريقة الدفع">
          <h1>طريقة الدفع</h1>
          <div class="pay-grid" role="radiogroup" aria-label="طريقة الدفع" id="payGroup">
            <label class="pay-card" tabindex="0" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="stc pay" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/STC%20PAY%20LOGO.png" alt="STC Pay">
            </label>
            <label class="pay-card" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="cash" class="visually-hidden"/>
              <strong>كاش</strong>
            </label>
            <label class="pay-card" style="grid-column:1/-1" tabindex="-1" role="radio" aria-checked="false">
              <input type="radio" name="payingMethod" value="mada" class="visually-hidden"/>
              <img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/MADA%20LOGO.png" alt="Mada">
            </label>
          </div>
          <div class="field-error" id="err-pay" style="text-align:center">يرجى اختيار طريقة الدفع</div>
        </section>

        <!-- 6) Map -->
        <section id="page6" class="page" aria-label="اختيار الموقع">
          <h1>الموقع على خريطة قوقل</h1>
          <div class="card">
            <div id="googleMap"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">إظهار موقعي</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">اضغط على الخريطة أو اسحب العلامة لتحديد موقعك</small>
          <div class="field-error" id="err-map" style="text-align:center">الرجاء تحديد الموقع على الخريطة</div>
        </section>

        <!-- 7) Done -->
        <section id="page7" class="page" aria-label="تم الحجز">
          <h1>شكراً لكم 🌟</h1>
          <div class="card text-center" style="max-width:720px">
            <p class="mb-3" style="color:#224652">تم استلام طلبكم، وسنؤكد الموعد على واتساب قريبًا.</p>
            <button id="rebook" class="btn btn-primary" type="button" style="min-height:52px;font-weight:800;border-radius:12px;padding:12px 18px">🔁 حجز جديد</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer nav -->
  <footer id="siteFooter" class="sticky-nav" aria-label="التنقل بين الخطوات">
    <div class="footer-inner">
      <div class="footer-brand">
        <span>نحل • <a href="https://nahl.app" target="_blank" rel="noopener">Nahl.app</a></span>
        <div class="footer-social">
          <a href="https://wa.me/966509027172" target="_blank" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="https://www.instagram.com/nahl.app?igsh=ZmljaXNncGtudjJ2" target="_blank" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
          <a href="https://www.tiktok.com/@nahl.app?_t=ZS-8zgmzEQTSQW&_r=1" target="_blank" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
        </div>
      </div>
      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer hidden">السابق</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>التالي</button>
      </div>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------------- Logo fallback ---------------- */
    function handleLogoError(img){
      const fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20&%20%20Soap/spong&Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/spong%26Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png",
        "https://dummyimage.com/180x54/027A93/ffffff.png&text=Sponge+%26+Soap"
      ];
      const i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; }
    }

    /* ---------------- API (legacy behavior preserved) ---------------- */
    const APP_ID = '33e0d05d-d771-46f4-a7e7-7c634b4e3a9e';
    const defaultLink2 = `https://nahl-platform.vercel.app/api/app/AM/general/${APP_ID}/form`;
    const RESERVE_URL_PRIMARY   = `${defaultLink2}/reserveAppointment`;
    const RESERVE_URL_FALLBACK  = `${defaultLink2.replace(/\/form\/?$/,'')}/reserveAppointment`;

    let controllers=[];
    async function callContent2(path, cb, abortable=false, retries=3){
      let signal='';
      if(abortable){
        controllers.forEach(([c])=>c.abort());
        controllers=[];
        const controller=new AbortController();
        signal=controller.signal;
        controllers.push([controller,signal]);
      }
      try{
        await new Promise(r=>setTimeout(r, 200));
        const fullUrl = defaultLink2+path;
        const res=await fetch(fullUrl,{method:'GET',redirect:'follow',...(abortable&&{signal}), cache:'no-store'});
        if(!res.ok){
          if(retries>0) return callContent2(path,cb,abortable,retries-1);
          throw new Error('Network');
        }
        const json=await res.json();
        cb(json);
      }catch(e){
        if(!String(e).includes('AbortError') && retries>0)
          setTimeout(()=>callContent2(path,cb,abortable,retries-1),600);
      }
    }

    async function postReservationTry(url, payload, contentType='text/plain;charset=UTF-8'){
      try{
        const res = await fetch(url, {
          method:'POST',
          mode:'cors',
          cache:'no-store',
          credentials:'omit',
          referrerPolicy:'no-referrer',
          headers:{ 'Content-Type': contentType, 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const raw = await res.text();
        let data=null; try{ data = JSON.parse(raw); }catch(_){}
        return { ok: res.ok, status: res.status, data, raw };
      }catch(err){
        return { ok:false, status:0, error:String(err) };
      }
    }

    // DO NOT CHANGE order (prevents regressions)
    async function postReservation(payload){
      let r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'text/plain;charset=UTF-8');
      if(!r.ok && (r.status===415 || r.status===406 || r.status===0)){
        r = await postReservationTry(RESERVE_URL_PRIMARY, payload, 'application/json;charset=UTF-8');
      }
      if(!r.ok && r.status===404){
        r = await postReservationTry(RESERVE_URL_FALLBACK, payload, 'text/plain;charset=UTF-8');
      }
      return r;
    }

    /* ---------------- Toast ---------------- */
    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.style.minWidth='260px'; div.style.color='#fff'; div.style.padding='10px 14px';
      div.style.borderRadius='10px'; div.style.boxShadow='0 10px 28px rgba(11,38,48,.14)';
      if(type==='error') div.style.background='#dc2626';
      else if(type==='success') div.style.background='#16a34a';
      else div.style.background='#0284c7';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }

    /* ---------------- STATE ---------------- */
    const DateTime=luxon.DateTime;
    const orderedPages=["page1","page2","page3","page4","page5","page6","page7"];
    const STEPS_LABELS=["الترحيب","الخدمة","الوقت","البيانات","الدفع","الموقع","تم"];
    const PAGE_BACKGROUNDS = {
      page1: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG1.jpg",
      page2: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG2.jpg",
      page3: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG3.jpg",
      page4: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG4.jpg",
      page5: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG5.jpg",
      page6: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG6.jpg",
      page7: "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG7.jpg"
    };

    // chips group mapping: which step a chip belongs to
    const STEP_GROUP_INDEX = { page1:0, page2:1, page3:2, page4:3, page5:4, page6:5, page7:6 };

    let selectedTime=null;
    let servicesCache=null, categoriesCache=null, itiPhone=null;
    let positionUrl="";
    const nForm={date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', locale:'ar'};

    /* ---------------- Helpers ---------------- */
    function setPageBackground(id){
      const url = PAGE_BACKGROUNDS[id] || PAGE_BACKGROUNDS.page1;
      document.documentElement.style.setProperty('--page-bg', `url("${url}")`);
    }
    function showPage(idx){
      const cur=document.querySelector('.page.active');
      const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} }, 260); });
      syncProgress(idx);
      setPageBackground(next.id);
      renderSummary(next.id);  // <-- chips reflect current page
      updateNextAvailability();
    }
    function getActiveIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';
      document.getElementById('miniStepTitle').textContent=STEPS_LABELS[Math.min(i,STEPS_LABELS.length-1)];
      const prev=document.getElementById('footer-prev');
      const next=document.getElementById('footer-next');
      const onThanks = (orderedPages[i]==='page7');
      prev.classList.toggle('hidden', i === 0 || onThanks);
      next.classList.toggle('hidden', onThanks);
    }
    function enforceDateMinToday(){
      const today = DateTime.now().toFormat('yyyy-LL-dd');
      const dateEl = document.getElementById('date');
      if(!dateEl) return;
      dateEl.setAttribute('min', today);
      if(!dateEl.value || dateEl.value < today) dateEl.value = today;
    }
    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }
    function validateMobile(){ return !!(itiPhone && itiPhone.isValidNumber()); }

    // Special plate hint
    function isSpecialPlate(numStr){
      if(!/^\d{4}$/.test(numStr)) return false;
      const allSame = /^(\d)\1{3}$/.test(numStr);
      const ascending = '0123456789'.includes(numStr);
      const descending = '9876543210'.includes(numStr);
      const palindrome = numStr === numStr.split('').reverse().join('');
      const pairs = /^(\d)\1(\d)\2$/.test(numStr);
      return allSame || ascending || descending || palindrome || pairs;
    }
    function updatePlateHint(){
      const v = ($('#plateNumber').val()||'').replace(/\D/g,'').slice(0,4);
      $('#plateNumber').val(v);
      const note = isSpecialPlate(v) ? 'رقم مميز 👌 — ممتاز للتوثيق السريع.' : 'نستخدم آخر ٤ أرقام للتأكيد فقط';
      $('#plateHelp').text(note);
      const pe = document.getElementById('err-plate');
      if(v.length>0 && v.length<4){ pe.style.display='block'; pe.textContent='رجاءً أدخل ٤ أرقام'; } else { pe.style.display='none'; }
    }

    /* ---------------- Summary chips (context-aware) ---------------- */
    function renderSummary(currentId){
      const wrap = document.getElementById('summaryChips'); if(!wrap) return;
      const activeId = currentId || (document.querySelector('.page.active')?.id) || 'page1';
      const currGroup = STEP_GROUP_INDEX[activeId] ?? 0;

      const areaTxt = $('#area').find(':selected').text() || '';
      const catTxt  = $('#serviceCat').find(':selected').text() || '';
      const srvTxt  = $('#service').find(':selected').text() || '';
      const cntTxt  = $('#serviceCount').val() || '';
      const dt      = nForm.date ? DateTime.fromISO(nForm.date).toFormat('d LLL yyyy') : '';
      const tm      = nForm.time ? nForm.time : '';
      const pay     = nForm.paymentMethod || '';
      const plate   = $('#plateNumber').val() || '';
      const locOk   = !!positionUrl;

      // define chips with their group index (which step they belong to)
      const chips = [
        {i:'fa-location-dot',   t:'المنطقة',   v:areaTxt, group:1},
        {i:'fa-layer-group',    t:'التصنيف',   v:catTxt,  group:1},
        {i:'fa-screwdriver-wrench', t:'الخدمة', v:srvTxt,  group:1},
        {i:'fa-car',            t:'عدد السيارات', v:cntTxt, group:1},
        {i:'fa-clock',          t:'الموعد',    v:(dt||tm)?((dt&&tm)?`${dt} • ${tm}`:(dt||tm)):'', group:2},
        {i:'fa-user',           t:'الاسم',     v:(nForm.customerN||''), group:3},
        {i:'fa-phone',          t:'الجوال',    v:(nForm.customerM||''), group:3},
        {i:'fa-id-card',        t:'لوحة',      v:plate, group:3},
        {i:'fa-credit-card',    t:'الدفع',     v:(pay?pay.toUpperCase():''), group:4},
        {i:'fa-map-pin',        t:'الموقع',     v:(locOk?'تم التحديد':'') , group:5},
      ];

      // show chips up to current group only; highlight current group's chips
      wrap.innerHTML='';
      chips
        .filter(c => c.v && c.group <= currGroup)
        .forEach(c=>{
          const el=document.createElement('div'); el.className='chip'+(c.group===currGroup?' current':'');
          el.innerHTML=`<i class="fa-solid ${c.i}"></i><span class="title">${c.t}:</span><span class="value">${c.v}</span>`;
          wrap.appendChild(el);
        });
    }

    /* ---------------- Time (same logic as working old) ---------------- */
    function parseTimeToLuxon(rawTime){
      let t = DateTime.fromISO(String(rawTime||'').trim(), { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'HH:mm:ss', { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'H:mm a',   { setZone:true });
      if (!t.isValid) t = DateTime.fromFormat(String(rawTime||''), 'H:mm',     { setZone:true });
      return t.isValid ? t : null;
    }
    function normalizeAvailability(r){
      const status = String(r.TS_status || r.status || r.TS_appointment_status || '').toLowerCase();
      const availableFlag = (typeof r.isAvailable === 'boolean') ? r.isAvailable : undefined;
      const booked   = Number(r.booked ?? r.TS_booked);
      const capacity = Number(r.capacity ?? r.TS_capacity);
      let remaining  = Number(r.remaining ?? r.TS_remaining);
      if (!Number.isFinite(remaining) && Number.isFinite(capacity) && Number.isFinite(booked)){
        remaining = capacity - booked;
      }
      const looksOpen =
        availableFlag === true ||
        ['available','open','free','empty','vacant','canceled'].includes(status) ||
        (Number.isFinite(remaining) ? remaining > 0 : (availableFlag !== false && !status));
      return { looksOpen, remaining, status, availableFlag };
    }

    let dayTimes = []; let timesLoaded = false;

    function fetchTimesForSelectedDate(){
      const dateEl = document.getElementById('date');
      const timeContainer = document.getElementById('time-container');
      const loc = document.getElementById('area').value || '';
      const srv = document.getElementById('service').value || '';
      const selectedISO = (dateEl.value || DateTime.now().toFormat('yyyy-LL-dd')).trim();

      if (!loc || !srv) {
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">اختر المنطقة والخدمة لعرض المواعيد</div>`;
        window.selectedTime = null; selectedTime = null;
        updateNextAvailability();
        return;
      }

      dateEl.disabled = true;
      setLoadingTimes(true);
      timeContainer.innerHTML = `
        <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
          <span class="visually-hidden">Loading...</span>
        </div>`;

      const now = DateTime.now().setZone('Asia/Riyadh');
      const isToday = selectedISO === now.toISODate();

      const qs = `/appointments?startDate=${encodeURIComponent(selectedISO)}&location=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}&onlyAvailable=1`;

      callContent2(qs, (res) => {
        const rowsRaw = (res?.data?.appointments || []);

        const filtered = rowsRaw.filter(r => {
          const d = DateTime.fromISO(r.TS_appointment_date, { setZone: true });
          if (!d.isValid || d.toISODate() !== selectedISO) return false;
          const t = parseTimeToLuxon(r.TS_appointment_time);
          if (!t) return false;
          const { looksOpen } = normalizeAvailability(r);
          if (!looksOpen) return false;
          if (isToday) {
            const slot = now.set({ hour: t.hour, minute: t.minute, second: 0 });
            if (slot < now.plus({ minutes: 5 })) return false;
          }
          return true;
        });

        const list = filtered.map(r => {
          const t = parseTimeToLuxon(r.TS_appointment_time);
          return { label: t.toLocaleString(DateTime.TIME_SIMPLE), actual12: t.toFormat('hh:mm a') };
        });

        const seen = new Set();
        dayTimes = list
          .filter(x => { if (seen.has(x.actual12)) return false; seen.add(x.actual12); return true; })
          .sort((a,b)=> a.actual12.localeCompare(b.actual12));

        timesLoaded = true;
        renderSelectedDateTimes(selectedISO);
        dateEl.disabled = false;
        setLoadingTimes(false);
      }, true);
    }

    function renderSelectedDateTimes(selectedISO){
      const timeContainer = document.getElementById('time-container');
      timeContainer.innerHTML = '';

      if (!timesLoaded) {
        timeContainer.innerHTML = `
          <div class="spinner-border text-info" role="status" style="grid-column:1/-1;justify-self:center;">
            <span class="visually-hidden">Loading...</span>
          </div>`;
        return;
      }

      if (!dayTimes.length) {
        timeContainer.innerHTML = `<div style="grid-column:1/-1;justify-self:center" class="text-muted">لا توجد مواعيد متاحة</div>`;
        window.selectedTime = null; selectedTime = null;
        updateNextAvailability();
        return;
      }

      dayTimes.forEach((t) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-option';
        btn.setAttribute('role','radio');
        btn.setAttribute('aria-checked','false');
        btn.setAttribute('dir','ltr');
        btn.textContent = t.label;

        btn.addEventListener('click', () => {
          [...timeContainer.children].forEach(el => el.setAttribute('aria-checked','false'));
          btn.setAttribute('aria-checked','true');

          const parsed = DateTime.fromFormat(t.actual12, 'h:mm a');
          nForm.date = selectedISO;
          nForm.time = parsed.isValid ? parsed.toFormat('HH:mm') : t.actual12;

          window.selectedTime = { ui: t.label, iso: nForm.time };
          selectedTime        = window.selectedTime;
          renderSummary('page3'); // update chips as timing chosen
          updateNextAvailability();
        });

        timeContainer.appendChild(btn);
      });
    }

    /* ---------------- ResizeObserver for header/footer ---------------- */
    function installResizeObservers(){
      const header = document.getElementById('siteHeader');
      const footer = document.getElementById('siteFooter');
      const ro = new ResizeObserver(entries=>{
        entries.forEach(entry=>{
          if(entry.target.id==='siteHeader'){
            document.documentElement.style.setProperty('--header-h', entry.contentRect.height+'px');
          }else if(entry.target.id==='siteFooter'){
            document.documentElement.style.setProperty('--footer-h', entry.contentRect.height+'px');
          }
        });
      });
      if(header) ro.observe(header);
      if(footer) ro.observe(footer);
    }

    /* ---------------- Build payload (legacy-compatible) ---------------- */
    function buildPayload(){
      const loc  = $('#area').val();
      const svcC = $('#serviceCat').val();
      const svc  = $('#service').val();
      const cnt  = $('#serviceCount').val() || '1';

      const location     = (loc  !== null && loc  !== '') ? String(loc)  : undefined;
      const serviceCat   = (svcC !== null && svcC !== '') ? String(svcC) : undefined;
      const service      = (svc  !== null && svc  !== '') ? String(svc)  : undefined;
      const serviceCount = String(cnt);

      // IMPORTANT: server expects digits only
      const phoneDigits = itiPhone?.getNumber?.()?.replace(/^\+/, '') || '';
      const pay         = (nForm.paymentMethod || '').toLowerCase();

      return {
        date: nForm.date,
        time: nForm.time,
        location,
        service,
        serviceCount,
        serviceCat,
        customerM: phoneDigits,
        customerN: nForm.customerN,
        paymentMethod: pay,
        urlLocation: nForm.urlLocation,
        locationDescription: nForm.locationDescription || '',
        locale: 'ar'
      };
    }

    /* ---------------- Init & bindings ---------------- */
    $(function(){
      installResizeObservers();
      setPageBackground('page1');
      enforceDateMinToday();

      // Preload backgrounds
      (function preloadBG(){
        Object.values(PAGE_BACKGROUNDS).forEach(src => { const i=new Image(); i.src = src; });
      })();

      // Select2
      $('#area').select2({width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
      $('#serviceCat').select2({width:'100%',placeholder:'التصنيف', dir:'rtl'});
      $('#service').select2({width:'100%',placeholder:'الخدمة', dir:'rtl'});
      $('#carBrand').select2({width:'100%',placeholder:'ماركة السيارة', dir:'rtl'});
      $('#area, #serviceCat, #service').on('select2:open', () => {
        $('.select2-search__field').attr('dir','rtl');
      });

      // intl-tel-input (better mobile UX)
      itiPhone=window.intlTelInput(document.querySelector('#mobile'),{
        initialCountry:'sa',
        onlyCountries:['sa','ae','bh','kw','om','qa'],
        separateDialCode:true,
        placeholderNumberType:'MOBILE',
        utilsScript:'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
      });
      $('#mobile').attr({ inputmode:'tel', autocomplete:'tel' }).on('blur', ()=> {
        const ok = itiPhone && itiPhone.isValidNumber();
        document.getElementById('err-mobile').style.display = ok ? 'none':'block';
      });

      // Load locations → services (page-2 spinner)
      setLoadingServices(true);
      callContent2(`/locations`, res=>{
        const list=res?.data||[]; const ds=list.map(l=>({id:l.id,text:l.TS_location_arabic_name}));
        $('#area').empty().select2({data:ds,width:'100%'});
        if(ds.length){ $('#area').val(ds[0].id).trigger('change'); }
        else { setLoadingServices(false); showToast('error','لا توجد مناطق متاحة حالياً'); }
        renderSummary('page2');
      });

      $('#area').on('change', function(){
        nForm.location=this.value; setLoadingServices(true);
        callContent2(`/services?location=${encodeURIComponent(this.value)}`, res=>{
          servicesCache=res?.data?.services||[]; categoriesCache=res?.data?.servicesCat||[];
          const cats=categoriesCache.map(c=>({id:c.TS_category_id,text:c.TS_category_arabic_name}));
          $('#serviceCat').empty().select2({data:cats,width:'100%'});
          if(cats.length){ $('#serviceCat').val(cats[0].id).trigger('change'); }
          setLoadingServices(false);
          renderSummary('page2');
          updateNextAvailability();
        }, true);
      });

      $('#serviceCat').on('change', function(){
        nForm.serviceCat=this.value; const cid=Number(this.value);
        const items=servicesCache?.filter(s=>Number(s.TS_category_id)===cid)?.sort((a,b)=>a.TS_service_id-b.TS_service_id)?.map(s=>({id:s.TS_service_id,text:s.TS_service_arabic_name}))||[];
        $('#service').empty().select2({data:items,width:'100%'});
        if(items.length){ $('#service').val(items[0].id).trigger('change'); }
        renderSummary('page2'); updateNextAvailability();
      });

      $('#service').on('change', function(){
        nForm.service = this.value || '';
        renderSummary('page2'); updateNextAvailability();
      });

      // Brands
      const brands=["Toyota","Nissan","Hyundai","Kia","Honda","Lexus","BMW","Mercedes-Benz","Chevrolet","Ford","Mazda","Mitsubishi","Aston Martin","Other"].sort().map(b=>({id:b,text:b}));
      $('#carBrand').empty().select2({data:brands,width:'100%'});

      // Contact + vehicle
      $('#name').on('input', function(){ nForm.customerN = this.value.trim(); renderSummary('page4'); updateNextAvailability(); });
      $('#mobile').on('input', function(){ renderSummary('page4'); updateNextAvailability(); });
      $('#carName').on('input', function(){ updateNextAvailability(); });
      $('#serviceCount').on('change', function(){ nForm.serviceCount = this.value || '1'; renderSummary('page2'); updateNextAvailability(); });
      $('#plateNumber').on('input', function(){ updatePlateHint(); renderSummary('page4'); updateNextAvailability(); });

      // Date init + on change
      const today=DateTime.now().toFormat('yyyy-LL-dd');
      $('#date').val(today).attr('min',today);
      $('#date').on('change', ()=>{ fetchTimesForSelectedDate(); renderSummary('page3'); });

      // Footer nav
      const $prev=document.getElementById('footer-prev');
      const $next=document.getElementById('footer-next');

      async function gotoNext(){
        const i=getActiveIndex(); const id=orderedPages[i];

        if(id==='page1'){ showPage(1); return; }

        if(id==='page2'){
          const areaOk=!!$('#area').val(), catOk=!!$('#serviceCat').val(), svcOk=!!$('#service').val();
          document.getElementById('err-area').style.display = areaOk ? 'none':'block';
          document.getElementById('err-serviceCat').style.display = catOk ? 'none':'block';
          document.getElementById('err-service').style.display = svcOk ? 'none':'block';
          if(!areaOk||!catOk||!svcOk){ showToast('error','يرجى إكمال اختيار المنطقة/التصنيف/الخدمة'); return; }
          showPage(2); // to page3
          document.getElementById('date').dispatchEvent(new Event('change'));
          return;
        }

        if(id==='page3'){
          if(!selectedTime){ showToast('error','الرجاء اختيار وقت'); return; }
          showPage(3);
          return;
        }

        if(id==='page4'){
          const nameOk = ($('#name').val()||'').trim().length>0;
          const phoneOk = validateMobile();
          document.getElementById('err-name').style.display = nameOk ? 'none' : 'block';
          document.getElementById('err-mobile').style.display = phoneOk ? 'none' : 'block';
          if(!nameOk || !phoneOk){ showToast('error','يرجى التحقق من الاسم ورقم الجوال'); return; }

          nForm.customerN = ($('#name').val()||'').trim();
          nForm.customerM = itiPhone.getNumber().replace(/^\+/, ''); // digits-only

          nForm.locationDescription=[$('#carBrand').val()||'', $('#carName').val()||'', $('#plateNumber').val()||''].filter(Boolean).join(', ');
          showPage(4);
          return;
        }

        if(id==='page5'){
          if(!nForm.paymentMethod){ document.getElementById('err-pay').style.display='block'; showToast('error','اختر طريقة الدفع'); return; }
          document.getElementById('err-pay').style.display='none';
          showPage(5);
          return;
        }

        if(id==='page6'){
          if(!positionUrl){ document.getElementById('err-map').style.display='block'; showToast('error','الرجاء تحديد الموقع'); return; }
          document.getElementById('err-map').style.display='none';
          nForm.urlLocation=positionUrl;

          const payload = buildPayload();
          const r = await postReservation(payload);

          if(r.ok && r.data?.success){
            if(r.data?.otp){
              showToast('error','الخادم يطلب رمز تحقق (OTP). عطّل خيار OTP أو أضف خطوة للرمز.');
              return;
            }
            showToast('success','تم إنشاء الحجز');
            showPage(6);
          }else{
            const msg = r?.data?.msgAR
              || (r.status===404 ? 'المسار غير موجود: تأكد من /form/reserveAppointment'
                                 : r.status===0   ? 'تعذر الاتصال بالخادم (تحقق من CORS/الشبكة)'
                                                  : 'تعذر إنشاء الحجز');
            showToast('error', msg);
          }
          return;
        }

        const nextIndex=Math.min(i+1, orderedPages.length-1);
        showPage(nextIndex);
      }

      $next.addEventListener('click', gotoNext);
      $prev.addEventListener('click', ()=>{ const i=getActiveIndex(); showPage(Math.max(i-1,0)); });

      // Payment ARIA
      const payGroup = document.getElementById('payGroup');
      const payCards = [...payGroup.querySelectorAll('.pay-card')];
      payCards.forEach((card, idx)=>{
        const input = card.querySelector('input');
        const choose = () => {
          payCards.forEach(c=>{ c.setAttribute('aria-checked','false'); c.setAttribute('tabindex','-1'); c.querySelector('input').checked=false; });
          card.setAttribute('aria-checked','true'); card.setAttribute('tabindex','0'); input.checked=true; nForm.paymentMethod=input.value; renderSummary('page5'); updateNextAvailability();
        };
        card.addEventListener('click', choose);
        card.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); choose(); }
          if(['ArrowRight','ArrowDown','ArrowLeft','ArrowUp'].includes(e.key)){
            e.preventDefault();
            const i = payCards.indexOf(card);
            const nextI = (e.key==='ArrowRight'||e.key==='ArrowDown') ? Math.min(i+1,payCards.length-1) : Math.max(i-1,0);
            payCards[nextI].focus();
          }
        });
      });

      // Rebook
      $('#rebook').on('click', ()=>location.href='/');

      // initial summary/progress
      renderSummary('page1');
      syncProgress(0);
    });

    /* Enable/disable Next based on step validity */
    function updateNextAvailability(){
      const i = getActiveIndex();
      const nextBtn = document.getElementById('footer-next');
      let enable = true;
      if(i === 1){ // page2
        enable = !!($('#area').val() && $('#service').val());
      } else if(i === 2){ // page3 time
        enable = !!selectedTime;
      } else if(i === 3){ // page4 contact
        const nameOk = ($('#name').val()||'').trim().length > 0;
        const phoneOk = validateMobile();
        enable = nameOk && phoneOk;
      } else if(i === 4){ // page5 payment
        enable = !!nForm.paymentMethod;
      } else if(i === 5){ // page6 map
        enable = !!positionUrl;
      }
      nextBtn.disabled = !enable;
      nextBtn.classList.toggle('disabled', !enable);
    }

    /* ---------------- Google Map ---------------- */
    let map, marker;
    function initMap(){
      const def={lat:26.34165524787632,lng:50.11524831545726};
      map=new google.maps.Map(document.getElementById('googleMap'),{center:def,zoom:12,disableDoubleClickZoom:true});
      marker=new google.maps.Marker({position:def,map,draggable:true,title:'اسحب أو اضغط لتحديد الموقع'});
      const setPos=(latLng,pan=false)=>{
        if(!latLng) return;
        marker.setPosition(latLng);
        if(pan) map.panTo(latLng);
        map.setZoom(17);
        positionUrl=`https://www.google.com/maps/search/?api=1&query=${latLng.lat()},${latLng.lng()}`;
        const hint = document.getElementById('mapHint');
        if(hint) hint.innerHTML = `تم اختيار الموقع: <strong>${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}</strong>`;
        renderSummary('page6'); updateNextAvailability();
      };
      marker.addListener('dragend', ({latLng})=>setPos(latLng));
      map.addListener('click', ({latLng})=>setPos(latLng));
      const btn=document.getElementById('show-my-location');
      if(btn){
        btn.addEventListener('click', ()=>{
          if(!navigator.geolocation){ showToast('error','المتصفح لا يدعم تحديد الموقع'); return; }
          navigator.geolocation.getCurrentPosition(
            pos=>setPos(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude),true),
            err=>{ const msg = err?.message || 'رجاءً فعّل الـ GPS وأذونات الموقع'; showToast('error','تعذر تحديد موقعك: '+msg); },
            { enableHighAccuracy:true, timeout:10000, maximumAge:30000 }
          );
        });
      }
    }
    window.initMap = initMap;
  </script>

  <!-- Google Maps (async) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&callback=initMap&v=weekly&loading=async" async defer></script>
</body>
</html>
