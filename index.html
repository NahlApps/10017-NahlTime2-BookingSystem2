<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حجوزات المواعيد</title>

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <style>
    :root{
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --surface-000:#FFF; --border-300:#D4E0E6;
      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 6px rgba(11,38,48,.07);
      --shadow-sm:0 3px 12px rgba(11,38,48,.09);
      --shadow-md:0 10px 28px rgba(11,38,48,.14);
      --ease:cubic-bezier(.22,.61,.36,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms;
      --header-h:76px; --footer-h:118px;
      --page-bg:url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Time%20Hero.jpg");
    }
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34)), var(--page-bg) center/cover no-repeat fixed;
      min-height:100dvh; display:flex; flex-direction:column;
      padding-top:var(--header-h); padding-bottom:var(--footer-h);
    }
    header{ position:fixed; inset:0 0 auto; z-index:9; background:rgba(11,38,48,.36); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,.15); }
    .header-inner{ max-width:1120px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .brand img{height:64px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}
    .mini-progress{display:flex; align-items:center; gap:10px; width:100%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease);}
    main{flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0}
    #app{width:100%; max-width:1120px}
    .stage{position:relative; min-height:560px; padding:8px 0 20px}
    .page{display:flex; flex-direction:column; align-items:center; gap:20px; padding:24px 12px 28px}
    .page h1{font-size:1.375rem; font-weight:800; margin:0; text-align:center}
    .card{ background:rgba(255,255,255,.92); color:#0B2630; border-radius:14px; box-shadow:var(--shadow-md); padding:24px; width:100%; max-width:920px; }
    .form-control, select, .select2-selection{ background:#fff; color:#0B2630; border:1px solid var(--border-300)!important; border-radius:14px!important; min-height:52px; text-align:center; font-size:16px;}
    .form-label{ margin-bottom:6px; font-size:.9rem; font-weight:800; color:#224652 }
    .field-error{ color:#dc2626; font-size:.85rem; margin-top:6px; display:none }
    .footer-inner{ max-width:1120px; margin:0 auto; padding:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between}
    .footer-total{ color:#fff; font-weight:800; display:flex; align-items:center; gap:6px; white-space:nowrap; }
    .footer-actions{ display:flex; gap:12px; width:100%; max-width:420px; }
    .btn-footer{ flex:1; border:1px solid var(--border-300); border-radius:14px; padding:16px; min-height:56px; font-weight:800; background:#fff; color:#027A93; }
    footer.sticky-nav{ position:sticky; bottom:0; z-index:10; background:rgba(11,38,48,.45); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.15); }
    @media (max-width: 520px){ .footer-inner{flex-direction:column; align-items:flex-start} .footer-actions{max-width:none; width:100%} }
    .small-muted{font-size:.9rem; color:#6b7280}
    .chip{display:inline-flex; gap:6px; align-items:center; border:1px solid #dfe7eb; padding:6px 10px; border-radius:999px; background:#fff; font-size:.85rem}
    .coupon-ok{ color:#166534 }
    .coupon-bad{ color:#b91c1c }
  </style>
</head>
<body>
<header id="siteHeader">
  <div class="header-inner">
    <div class="brand"><img src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Nahl%20Logo.png" alt="Nahl"/></div>
    <div class="mini-progress" aria-hidden="true">
      <div class="bar"><span id="miniBarFill" style="width:28%"></span></div>
      <div class="step" id="miniStepTitle">الخدمة</div>
    </div>
  </div>
</header>

<main>
  <div id="app">
    <div class="stage">
      <!-- صفحة الخدمة والمنطقة (Page 2) -->
      <section id="page2" class="page" aria-label="اختيار المنطقة والخدمة">
        <h1>اختيار الخدمة</h1>

        <div class="card position-relative" id="servicesCard">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">المنطقة</label>
              <select id="area" style="width:100%"></select>
              <div class="field-error" id="err-area">يرجى اختيار المنطقة</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">التصنيف</label>
              <select id="serviceCat" style="width:100%"></select>
              <div class="field-error" id="err-serviceCat">يرجى اختيار التصنيف</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">الخدمة</label>
              <select id="service" style="width:100%"></select>
              <div class="field-error" id="err-service">يرجى اختيار الخدمة</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">عدد السيارات</label>
              <select id="serviceCount" class="form-select">
                <option value="1" selected>1</option>
                <option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">تفاصيل الخدمة</label>
              <div id="serviceDetails" class="small-muted bg-white border rounded-3 p-3">—</div>
            </div>
            <div class="col-12">
              <label class="form-label">سعر الخدمة (شامل الضريبة)</label>
              <div id="servicePrice" class="fw-bold text-primary bg-white border rounded-3 p-3">—</div>
            </div>
          </div>

          <!-- ✅ خدمات إضافية -->
          <hr class="mt-4 mb-3"/>
          <div class="mt-2">
            <label class="form-label">خدمات إضافية (اختياري)</label>
            <div id="additionalServicesWrap">
              <div class="text-muted small">جاري تحميل الخدمات الإضافية…</div>
            </div>
            <div id="as-error" class="field-error"></div>
          </div>

          <!-- ✅ كوبونات -->
          <hr class="mt-4 mb-3"/>
          <div class="mt-2">
            <label class="form-label">قسيمة خصم (اختياري)</label>
            <div class="d-flex gap-2 flex-wrap">
              <input id="couponCode" class="form-control" style="flex:1; min-width:200px" placeholder="أدخل كود الخصم (مثال: WELCOME10)"/>
              <button id="applyCouponBtn" class="btn btn-primary" type="button" style="min-height:52px; border-radius:12px; font-weight:800">تطبيق</button>
              <button id="removeCouponBtn" class="btn btn-outline-secondary" type="button" style="min-height:52px; border-radius:12px; font-weight:800; display:none">إزالة</button>
            </div>
            <div class="small mt-2" id="couponStatus"></div>
          </div>

        </div>
      </section>
    </div>
  </div>
</main>

<footer id="siteFooter" class="sticky-nav" aria-label="التنقل بين الخطوات">
  <div class="footer-inner">
    <div class="footer-total">
      <span>إجمالي الطلب:</span>
      <span class="chip"><span id="subtotalChip">—</span></span>
      <span id="couponChip" class="chip" style="display:none">خصم: <strong id="couponDiscountDisplay">—</strong></span>
      <span class="chip">المجموع النهائي: <strong id="finalTotalDisplay">—</strong></span>
    </div>
    <div class="footer-actions">
      <button id="footer-next" type="button" class="btn-footer primary">التالي</button>
    </div>
  </div>
</footer>

<!-- libs -->
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /* ===== Config ===== */
  const APP_ID = '21eddbf5-efe5-4a5d-9134-b581717b17ff';
  const API_BASE = window.location.origin.replace(/\/$/, '');
  const ADDITIONAL_SERVICES_URL = `${API_BASE}/api/additional-services`;
  const COUPONS_API_URL         = `${API_BASE}/api/coupons/validate`;

  /* ===== State ===== */
  let servicesCache = [];
  let categoriesCache = [];
  let baseServicePrice = 0;
  let additionalServicesList = [];
  let additionalServicesSelected = []; // array of IDs
  let additionalServicesTotal = 0;
  let carCount = 1;

  let couponApplied = null; // {code, discountAmount, type, value, message}
  let customerPhone = '';   // يمكنك تعبئته لاحقًا بعد إدخال الهاتف

  /* ===== Helpers ===== */
  const nf = new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const money = v => isFinite(v) ? nf.format(v) + ' ر.س' : '—';

  function computeSubtotal(){
    const unit = (Number(baseServicePrice)||0) + (Number(additionalServicesTotal)||0);
    return unit * carCount;
  }
  function computeFinalTotal(){
    const subtotal = computeSubtotal();
    const disc = Number(couponApplied?.discountAmount || 0);
    return Math.max(0, subtotal - disc);
  }
  function refreshTotalsUI(){
    const subtotal = computeSubtotal();
    document.getElementById('subtotalChip').textContent = money(subtotal);

    if (couponApplied && couponApplied.discountAmount > 0){
      document.getElementById('couponChip').style.display = '';
      document.getElementById('couponDiscountDisplay').textContent = money(couponApplied.discountAmount);
    } else {
      document.getElementById('couponChip').style.display = 'none';
    }

    document.getElementById('finalTotalDisplay').textContent = money(computeFinalTotal());
  }

  function setServicePriceAndDetails(serviceObj){
    const desc = serviceObj?.TS_service_descriptionAR || serviceObj?.TS_service_descriptionEN || '';
    document.getElementById('serviceDetails').textContent = desc || '—';

    const priceRaw = serviceObj?.TS_service_final_price;
    baseServicePrice = isFinite(Number(priceRaw)) ? Number(priceRaw) : 0;
    document.getElementById('servicePrice').textContent = baseServicePrice ? money(baseServicePrice) : '—';

    // تغير السعر يبطل الكوبون السابق إن وجد، ثم يُعاد التحقق تلقائيًا إن كان الكوبون موجودًا
    if (couponApplied) revalidateCouponIfApplied();
    refreshTotalsUI();
  }

  function recalcAdditionalServices(){
    let total = 0;
    const ids = [];
    additionalServicesList.forEach(s=>{
      const checked = document.getElementById(`as-${s.id}`)?.checked;
      if (checked){
        ids.push(String(s.id));
        const p = Number(s.price);
        if (isFinite(p)) total += p;
      }
    });
    additionalServicesSelected = ids;
    additionalServicesTotal = total;

    if (couponApplied) revalidateCouponIfApplied();
    refreshTotalsUI();
  }

  async function loadAdditionalServices(){
    const wrap = document.getElementById('additionalServicesWrap');
    try{
      const url = `${ADDITIONAL_SERVICES_URL}?appId=${encodeURIComponent(APP_ID)}`;
      const res = await fetch(url, { method: 'GET', cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      additionalServicesList = Array.isArray(data.services) ? data.services : [];

      if(!additionalServicesList.length){
        wrap.innerHTML = '<div class="text-muted small">لا توجد خدمات إضافية متاحة حاليًا</div>';
        return;
      }

      const rows = document.createElement('div');
      rows.className = 'row g-2';
      additionalServicesList.forEach(s=>{
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6';
        col.innerHTML = `
          <label class="form-check d-flex align-items-start gap-2 p-2 bg-white rounded-3 shadow-sm">
            <input id="as-${s.id}" type="checkbox" class="form-check-input mt-1" value="${String(s.id)}">
            <div class="flex-grow-1">
              <div class="fw-bold">${s.name||''}</div>
              ${s.description? `<div class="small text-muted">${s.description}</div>`:''}
              ${ (s.price!==null && s.price!==undefined && s.price!=='') ? `<div class="small text-primary">+ ${money(Number(s.price)||0)}</div>`:''}
            </div>
          </label>`;
        rows.appendChild(col);
      });
      wrap.innerHTML = ''; wrap.appendChild(rows);

      // Events
      additionalServicesList.forEach(s=>{
        document.getElementById(`as-${s.id}`)?.addEventListener('change', recalcAdditionalServices);
      });

    }catch(err){
      console.error('loadAdditionalServices error:', err);
      wrap.innerHTML = '<div class="text-danger small">تعذر تحميل الخدمات الإضافية الآن</div>';
    }
  }

  async function validateCouponOnServer(code){
    const subtotal = computeSubtotal();
    if(!code || !subtotal){
      return { ok:false, message:'أدخل كود صالح واختر خدمة أولًا' };
    }
    try{
      const url = `${COUPONS_API_URL}?appId=${encodeURIComponent(APP_ID)}&code=${encodeURIComponent(code)}&subtotal=${encodeURIComponent(subtotal)}&customer=${encodeURIComponent(customerPhone||'')}`;
      const res = await fetch(url, { method:'GET', cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json(); // شكل الرد من GAS
      return data;
    }catch(err){
      console.error('validateCouponOnServer error:', err);
      return { ok:false, message:'تعذر الاتصال بخدمة الكوبونات' };
    }
  }

  async function applyCoupon(){
    const code = (document.getElementById('couponCode').value||'').trim();
    const statusEl = document.getElementById('couponStatus');
    statusEl.textContent = 'جارٍ التحقق من الكود…'; statusEl.className='small';

    const resp = await validateCouponOnServer(code);
    if(resp && (resp.ok || resp.success)){
      const discount = Number(resp.discountAmount || resp.amount || 0);
      couponApplied = {
        code,
        discountAmount: Math.max(0, discount),
        type: resp.discountType || resp.type || '',
        value: resp.value || resp.percent || resp.fixed || '',
        message: resp.message || 'تم تطبيق القسيمة'
      };
      statusEl.innerHTML = `<span class="coupon-ok"><i class="fa-solid fa-badge-check"></i> ${couponApplied.message}</span>`;
      document.getElementById('removeCouponBtn').style.display = '';
    }else{
      couponApplied = null;
      statusEl.innerHTML = `<span class="coupon-bad"><i class="fa-solid fa-circle-xmark"></i> ${resp?.message || 'كود غير صالح'}</span>`;
      document.getElementById('removeCouponBtn').style.display = 'none';
    }
    refreshTotalsUI();
  }

  async function revalidateCouponIfApplied(){
    if(!couponApplied?.code) return;
    const code = couponApplied.code;
    const resp = await validateCouponOnServer(code);
    const statusEl = document.getElementById('couponStatus');

    if(resp && (resp.ok || resp.success)){
      couponApplied.discountAmount = Math.max(0, Number(resp.discountAmount||resp.amount||0));
      couponApplied.message = resp.message || 'تم تحديث القسيمة';
      statusEl.innerHTML = `<span class="coupon-ok">${couponApplied.message}</span>`;
      document.getElementById('removeCouponBtn').style.display = '';
    }else{
      statusEl.innerHTML = `<span class="coupon-bad">${resp?.message || 'أصبحت القسيمة غير صالحة للمجموع الحالي'}</span>`;
      couponApplied = null;
      document.getElementById('removeCouponBtn').style.display = 'none';
    }
  }

  function removeCoupon(){
    couponApplied = null;
    document.getElementById('couponStatus').textContent = 'تم إلغاء القسيمة.';
    document.getElementById('removeCouponBtn').style.display = 'none';
    refreshTotalsUI();
  }

  /* ===== Mock integrations for area/service list (replace with your API) ===== */
  // لو عندك API فعلي للخدمات/التصنيفات/المنطقة استخدمه. هنا نضيف بيانات بسيطة للتجربة.
  function loadMockAreaAndServices(){
    const areas = [{id:'riyadh', text:'الرياض'},{id:'jeddah', text:'جدة'}];
    $('#area').select2({data:areas, width:'100%', placeholder:'اختر المنطقة', dir:'rtl'}).val('riyadh').trigger('change');

    categoriesCache = [{id:1,text:'خارجي'},{id:2,text:'داخلي'}];
    $('#serviceCat').select2({data:categoriesCache, width:'100%', placeholder:'فئة الخدمة', dir:'rtl'}).val(1).trigger('change');

    servicesCache = [
      {TS_service_id:101, TS_service_arabic_name:'غسيل خارجي سريع', TS_service_descriptionAR:'تنظيف خارجي سريع', TS_service_final_price:60, TS_category_id:1},
      {TS_service_id:102, TS_service_arabic_name:'غسيل خارجي فاخر', TS_service_descriptionAR:'تنظيف خارجي شامل بتفاصيل', TS_service_final_price:90, TS_category_id:1},
      {TS_service_id:201, TS_service_arabic_name:'تنظيف داخلي', TS_service_descriptionAR:'تنظيف داخلي كامل', TS_service_final_price:120, TS_category_id:2},
    ];
    refreshServicesForCategory(1);
  }

  function refreshServicesForCategory(catId){
    const items = servicesCache.filter(s=>Number(s.TS_category_id)===Number(catId))
      .map(s=>({id:s.TS_service_id, text:s.TS_service_arabic_name}));
    $('#service').empty().select2({data:items, width:'100%', placeholder:'اختر الخدمة', dir:'rtl'});
    if(items.length){ $('#service').val(items[0].id).trigger('change'); }
  }

  /* ===== Events ===== */
  $(function(){
    $('#area').select2({width:'100%',placeholder:'اختر المنطقة', dir:'rtl'});
    $('#serviceCat').select2({width:'100%',placeholder:'فئة الخدمة', dir:'rtl'});
    $('#service').select2({width:'100%',placeholder:'الخدمة', dir:'rtl'});

    $('#serviceCat').on('change', function(){ refreshServicesForCategory(this.value); });
    $('#service').on('change', function(){
      const id = String(this.value||'');
      const svc = servicesCache.find(s=>String(s.TS_service_id)===id);
      setServicePriceAndDetails(svc || null);
    });
    $('#serviceCount').on('change', function(){ carCount = Math.max(1, parseInt(this.value||'1',10)); if(couponApplied) revalidateCouponIfApplied(); refreshTotalsUI(); });

    document.getElementById('applyCouponBtn').addEventListener('click', applyCoupon);
    document.getElementById('removeCouponBtn').addEventListener('click', removeCoupon);

    // Init
    loadMockAreaAndServices();
    loadAdditionalServices();
    refreshTotalsUI();
  });
</script>
</body>
</html>
