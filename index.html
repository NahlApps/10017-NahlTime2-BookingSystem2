<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>

  <!-- âœ… PWA Manifest (relative path for subfolder) -->
  <link rel="manifest" href="manifest.webmanifest">
  
  <!-- Browser / Taskbar color -->
  <meta name="theme-color" content="#01657A">

  <!-- ğŸ”¹ Favicon -->
  <link rel="icon" type="image/png" sizes="32x32"
        href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimePro/NahlTimeNewLOGO%20(2).png" />
  <link rel="shortcut icon"
        href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimePro/NahlTimeNewLOGO%20(2).png" />
  <link rel="apple-touch-icon"
        href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimePro/NahlTimeNewLOGO%20(2).png" />

  <!-- UI libs -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/css/intlTelInput.css" rel="stylesheet"/>

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NahlTime">
  <link rel="apple-touch-icon"
        href="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimePro/NahlTimeNewLOGO%20(2).png">

  <style>
    :root{
      --brand-700:#01657A; --brand-600:#027A93; --brand-200:#BFE6F0; --brand-050:#F0FAFC;
      --ink-900:#0B2630; --surface-000:#FFF; --border-300:#D4E0E6;

      --radius-md:14px; --radius-pill:999px;
      --shadow-xs:0 2px 6px rgba(11,38,48,.07);
      --shadow-sm:0 3px 12px rgba(11,38,48,.09);
      --shadow-md:0 10px 28px rgba(11,38,48,.14);

      --ease:cubic-bezier(.22,.61,.36,1);
      --dur-xs:160ms; --dur-sm:220ms; --dur-md:460ms;

      --header-h:76px;
      --footer-h:118px;

      --page-bg:url("https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG1.jpg");
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',sans-serif; color:#fff;
      background:
        linear-gradient(180deg, rgba(11,38,48,.58), rgba(11,38,48,.34)),
        var(--page-bg) center/cover no-repeat fixed;
      min-height:100vh; min-height:100dvh;
      display:flex; flex-direction:column;
      padding-top:var(--header-h);
      padding-bottom:var(--footer-h);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    header{
      position:fixed; top:0; left:0; right:0; z-index:999;
      background:rgba(11,38,48,.36); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .header-inner{
      max-width:1120px; width:100%; margin:0 auto;
      padding:10px 12px; display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:72px; width:auto; object-fit:contain; filter:drop-shadow(0 6px 20px rgba(0,0,0,.25));}

    .header-right{flex:1; display:flex; flex-direction:column; gap:6px}
    .mini-progress{display:flex; align-items:center; gap:10px; width:100%}
    .mini-progress .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
    .mini-progress .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand-600), var(--brand-200)); transition:width var(--dur-md) var(--ease); will-change:width}
    .mini-progress .step{font-weight:800; font-size:1rem}

    .summary-chips{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    .chip{
      display:inline-flex; align-items:center; gap:6px; max-width:100%;
      padding:6px 10px; border:1px solid rgba(255,255,255,.35);
      border-radius:999px; color:#fff; font-size:.85rem; background:transparent;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chip.current{ background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.75); box-shadow:0 0 0 2px rgba(255,255,255,.16) inset; }

    main{flex:1 0 auto; display:flex; justify-content:center; padding:8px 12px 0}
    #app{width:100%; max-width:1120px}
    .stage{position:relative; min-height:560px; padding:8px 0 20px}
    .page{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; gap:20px;
      padding:24px 12px 28px; overflow:auto; opacity:0; transform:translateY(12px) scale(.992);
      pointer-events:none;
    }
    .page.active{ pointer-events:auto; animation:pageIn var(--dur-md) var(--ease) both }
    .page.exit  { animation:pageOut var(--dur-sm) var(--ease) both }
    @keyframes pageIn{ from{opacity:0; transform:translateY(12px) scale(.992)} to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes pageOut{ from{opacity:1; transform:translateY(0) scale(1)} to{opacity:0; transform:translateY(14px) scale(.985)} }
    .page h1{font-size:1.375rem; font-weight:800; margin:0; text-align:center}

    .card{
      background:rgba(255,255,255,.88); color:#0B2630;
      border-radius:14px; box-shadow:var(--shadow-md);
      padding:24px; width:100%; max-width:920px; backdrop-filter:blur(6px);
    }

    .ppt-deck{position:relative; width:100%; max-width:920px; height:200px}
    .ppt-slide{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      opacity:0; transform:translateY(14px) scale(.98); transition:opacity .6s var(--ease), transform .6s var(--ease);
    }
    .ppt-slide .slide-card{ background:rgba(255,255,255,.92); color:#0B2630; border-radius:14px; box-shadow:var(--shadow-md); padding:18px 20px; text-align:center; width:min(820px,92%) }
    .ppt-slide.is-active{opacity:1; transform:none; z-index:2}
    .ppt-slide.is-exiting{opacity:0; transform:translateY(-8px) scale(.985); z-index:1}
    .ppt-dots{display:flex; gap:8px; justify-content:center; margin-top:12px}
    .ppt-dot{width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.55)}
    .ppt-dot.active{background:#fff}

    .form-control, select, .select2-selection{
      background:#fff; color:#0B2630; border:1px solid var(--border-300)!important; border-radius:14px!important;
      min-height:52px; text-align:center; font-size:16px;
      transition:border-color var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .form-control:focus{ box-shadow:0 0 0 4px rgba(2,122,147,.12) }
    .form-label{display:inline-block; margin-bottom:6px; font-size:.9rem; font-weight:800; color:#224652}
    .field-error{color:#dc2626; font-size:.85rem; margin-top:6px; display:none}
    .has-error .form-control, .has-error .select2-selection{ border-color:#dc2626 !important; }
    .has-error .field-error{display:block}

    .select2-container .select2-selection--single .select2-selection__rendered{color:#0B2630!important; line-height:52px!important;}
    .select2-container .select2-selection--single{height:52px!important; display:flex; align-items:center}
    .select2-dropdown{background:#fff; color:#0B2630}
    .select2-results__option, .select2-search__field{color:#0B2630}

    .time-toolbar{display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:8px}
    @media (min-width:768px){ .time-toolbar{grid-template-columns: 1fr; } }
    .btn-toggle{display:flex; gap:8px}
    .btn-toggle .btn{flex:1}

    .time-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    @media (min-width:540px){ .time-grid{grid-template-columns:repeat(3,1fr)} }
    .time-option{
      background:#fff; color:#0B2630; font-weight:800;
      border:1px solid var(--border-300); border-radius:14px;
      padding:14px 10px; min-height:64px; box-shadow:var(--shadow-xs);
      transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .time-option:hover{transform:translateY(-2px); background:var(--brand-050); box-shadow:var(--shadow-sm)}
    .time-option[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    .load-overlay{
      position:absolute; inset:0; background:rgba(255,255,255,.88); color:#0B2630;
      display:none; align-items:center; justify-content:center; gap:12px; border-radius:14px; backdrop-filter:blur(2px);
    }
    .load-overlay.show{display:flex; animation:fadeIn var(--dur-sm) var(--ease) both}
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .pay-grid{display:grid; grid-template-columns:1fr 1fr; gap:16px; width:100%; max-width:920px}
    .pay-card{
      background:#fff; color:#0B2630; border:1px solid var(--border-300); border-radius:14px;
      padding:24px; display:flex; justify-content:center; align-items:center; gap:16px;
      min-height:76px; cursor:pointer; transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .pay-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm); background:var(--brand-050)}
    .pay-card img{max-width:140px; height:auto}
    .pay-card[aria-checked="true"]{outline:3px solid var(--brand-600); outline-offset:2px}

    .map-search{position:relative; margin-bottom:12px}
    .map-search .form-control{min-height:48px; text-align:right}
    .map-search .fa-magnifying-glass{position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6b7280}
    #googleMap{width:100%;height:420px;border-radius:14px;overflow:hidden}

    footer.sticky-nav{
      position:sticky; bottom:0; z-index:40; background:rgba(11,38,48,.45);
      backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,.15);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .footer-inner{
      max-width:1120px; width:100%; margin:0 auto; padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .footer-brand{
      font-size:.95rem; color:#fff; opacity:.94;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap
    }
    .footer-brand a{color:#fff; text-decoration:underline}
    .footer-social{display:flex; align-items:center; gap:12px}
    .footer-social a{color:#fff; opacity:.95; font-size:1.2rem}

    .footer-total{
      color:#fff; font-weight:800;
      display:flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .footer-total-label{opacity:.9;}
    .footer-total-value{min-width:90px; text-align:start;}

    .footer-actions{display:flex; gap:12px; width:100%; max-width:420px;}
    .btn-footer{
      flex:1; border:1px solid var(--border-300); border-radius:14px;
      padding:16px 16px; min-height:56px; font-size:1rem; font-weight:800;
      background:#fff; color:#027A93;
      transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease),
        background var(--dur-xs) var(--ease), color var(--dur-xs) var(--ease),
        border-color var(--dur-xs) var(--ease);
    }
    .btn-footer:hover{transform:translateY(-2px); box-shadow:var(--shadow-sm)}
    .btn-footer.primary{background:#027A93; color:#fff; border-color:#027A93}
    .btn-footer.hidden{visibility:hidden}
    .btn-footer:disabled{opacity:.6; pointer-events:none}
    #footer-wait{display:none; align-items:center; gap:10px; color:#fff; font-weight:800}
    #footer-wait.show{display:flex}

    @media (max-width: 480px){
      .brand img{ height:64px }
      .summary-chips{
        overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;
        gap:6px; padding-bottom:2px; scrollbar-width:thin;
      }
      .summary-chips::-webkit-scrollbar{ height:4px }
      .chip{ padding:4px 8px; font-size:.78rem }
      .chip .title{ display:none }
      .chip .value{ max-width:140px; overflow:hidden; text-overflow:ellipsis }

      .footer-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .footer-actions{width:100%; max-width:none;}
      .footer-brand{width:100%; justify-content:space-between}
      .footer-total{width:100%; justify-content:flex-start;}
      .btn-footer{min-height:58px; font-size:1.05rem}
    }

    .iti{ width:100%; }
    html[dir="rtl"] .iti--allow-dropdown .iti__flag-container{ left:8px; right:auto; }
    html[dir="rtl"] .iti--allow-dropdown input#mobile.form-control{
      padding-left: calc(76px + 8px);
      padding-right: 12px;
      text-align: left; direction: ltr;
    }

    /* ğŸ Offers button (Page 1) */
    .btn-offers-pill{
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-weight:800;
      font-size:.95rem;
      background:rgba(255,255,255,.9);
      color:var(--brand-700);
      box-shadow:var(--shadow-sm);
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease), background var(--dur-xs) var(--ease);
    }
    .btn-offers-pill:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-md);
      background:#fff;
    }
    .btn-offers-pill i{
      font-size:1rem;
    }

    /* ğŸ Offers modal */
    .offers-modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1200;
    }
    .offers-modal.show{
      display:flex;
      animation:fadeIn var(--dur-sm) var(--ease) both;
    }
    .offers-backdrop{
      position:absolute; inset:0;
      background:rgba(11,38,48,.55);
      backdrop-filter:blur(6px);
    }
    .offers-dialog{
      position:relative; z-index:1;
      background:rgba(255,255,255,.98);
      color:#0B2630;
      border-radius:18px;
      box-shadow:var(--shadow-md);
      width:100%;
      max-width:420px;
      max-height:min(70vh,520px);
      padding:18px 18px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .offers-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .offers-title{
      margin:0;
      font-size:1.05rem;
      font-weight:800;
    }
    .offers-close{
      border:none;
      background:transparent;
      color:#4b5563;
      width:32px;
      height:32px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background var(--dur-xs) var(--ease), transform var(--dur-xs) var(--ease);
    }
    .offers-close:hover{
      background:rgba(15,23,42,.06);
      transform:translateY(-1px);
    }
    .offers-filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .offers-filter-chip{
      border-radius:999px;
      border:1px solid #E5E7EB;
      background:#F9FAFB;
      padding:4px 10px;
      font-size:.78rem;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      transition:background var(--dur-xs) var(--ease), border-color var(--dur-xs) var(--ease), color var(--dur-xs) var(--ease);
    }
    .offers-filter-chip.active{
      background:rgba(2,122,147,.08);
      border-color:#027A93;
      color:#027A93;
    }
    .offers-list{
      margin-top:4px;
      flex:1 1 auto;
      overflow:auto;
      padding-right:2px;
    }
    .offer-card{
      background:#F9FAFB;
      border-radius:12px;
      border:1px solid #E5E7EB;
      padding:10px 12px;
      margin-bottom:8px;
    }
    .offer-title{
      font-size:.95rem;
      font-weight:800;
      margin:0 0 4px;
    }
    .offer-body{
      font-size:.85rem;
      color:#4b5563;
      margin:0 0 6px;
    }
    .offer-tag-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:space-between;
    }
    .offer-tag{
      font-size:.75rem;
      padding:2px 8px;
      border-radius:999px;
      background:#EEF2FF;
      color:#3730A3;
    }
    .offer-dates{
      font-size:.75rem;
      color:#6b7280;
    }
    .offer-image{
      width:100%;
      max-height:160px;
      border-radius:10px;
      object-fit:cover;
      margin-top:6px;
    }
    .offer-coupon-chip{
      font-size:.8rem;
      padding:3px 8px;
      border-radius:999px;
      background:#ECFDF3;
      color:#15803D;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .offer-apply-btn{
      margin-top:6px;
      border-radius:999px;
      border:none;
      background:#027A93;
      color:#fff;
      font-size:.85rem;
      padding:6px 10px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background var(--dur-xs) var(--ease), transform var(--dur-xs) var(--ease), box-shadow var(--dur-xs) var(--ease);
    }
    .offer-apply-btn:hover{
      background:#01657A;
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(2,122,147,.3);
    }
    @media (max-width:480px){
      .offers-dialog{
        max-width:92%;
        max-height:70vh;
        padding:14px 14px 12px;
      }
    }
    body.offers-open{
      overflow:hidden;
    }
  </style>
</head>
<body>
  <div id="toastWrap" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1050;display:flex;flex-direction:column;gap:8px"></div>

  <header id="siteHeader">
    <div class="header-inner">
      <div class="brand">
        <img id="brandLogo"
             alt="Nahl Time"
             src="https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimePro/NahlTimeNewLOGO%20(2).png"
             onerror="handleLogoError(this)" />
      </div>

      <div class="header-right">
        <div class="mini-progress" aria-hidden="true">
          <div class="bar"><span id="miniBarFill" style="width:0%"></span></div>
          <div class="step" id="miniStepTitle">Ø§Ù„ØªØ±Ø­ÙŠØ¨</div>
        </div>
        <div id="summaryChips" class="summary-chips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <main>
    <div id="app">
      <div class="stage">
        <!-- 1) Welcome -->
        <section id="page1" class="page active" aria-label="Ø§Ù„ØªØ±Ø­ÙŠØ¨">
          <h1>âœ¨ ØºØ³ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø·ÙˆØ§Ø¨ÙŠØ±</h1>

          <div id="pptDeck" class="ppt-deck">
            <div class="ppt-slide is-active">
              <div class="slide-card">
                <h3 class="mb-2">Ù†Ø¬ÙŠÙƒ Ù„ÙŠÙ† Ø¨Ø§Ø¨ Ø¨ÙŠØªÙƒ</h3>
                <p class="m-0">Ø­Ø¬Ø² Ø³Ø±ÙŠØ¹ â€¢ Ø®Ø¯Ù…Ø© Ù…ØªÙ†Ù‚Ù„Ø© â€¢ Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙÙŠ ÙƒÙ„ ØªÙØµÙŠÙ„</p>
              </div>
            </div>
            <div class="ppt-slide">
              <div class="slide-card">
                <h3 class="mb-2">Ù…ÙˆØ§Ø¯ ÙØ§Ø®Ø±Ø©</h3>
                <p class="m-0">Ù…Ù†ØªØ¬Ø§Øª Ø¢Ù…Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù…Ø¹ Ø¹Ù†Ø§ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©</p>
              </div>
            </div>
            <div class="ppt-slide">
              <div class="slide-card">
                <h3 class="mb-2">Ù…ÙˆØ¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø±Ø§Ø­ØªÙƒ</h3>
                <p class="m-0">Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ â€” ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¹Ù„ÙŠÙ†Ø§</p>
              </div>
            </div>
          </div>
          <div id="pptDots" class="ppt-dots" aria-hidden="true"></div>

          <!-- ğŸ Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ… (Ø²Ø± ÙŠÙØªØ­ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨) -->
          <div class="mt-3" style="display:flex;justify-content:center;">
            <button id="btnShowOffers" type="button" class="btn-offers-pill">
              <i class="fa-solid fa-gift"></i>
              <span>Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…</span>
            </button>
          </div>

          <div class="card text-center" style="max-width:860px">
            <p class="mb-0" style="color:#224652">Ø§Ù†Ø·Ù„Ù‚ â€” Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø©</p>
          </div>
        </section>

        <!-- 2) Service & Location -->
        <section id="page2" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø©">
          <h1>ÙˆÙŠÙ† ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>

          <div class="card position-relative" id="servicesCard">
            <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <select id="area" style="width:100%"></select>
            <div class="field-error" id="err-area">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>

            <div class="row g-3 mt-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                <select id="serviceCat" style="width:100%"></select>
                <div class="field-error" id="err-serviceCat">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <select id="service" style="width:100%"></select>
                <div class="field-error" id="err-service">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</div>
              </div>

              <div class="col-12">
                <label class="form-label" id="serviceDetailsLabel">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <div id="serviceDetails"
                     class="small text-muted bg-white border rounded-3 p-3"
                     style="border-radius:14px;">
                  Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‡Ù†Ø§.
                </div>
              </div>

              <div class="col-12">
                <label class="form-label" id="servicePriceLabel">Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</label>
                <div id="servicePrice"
                     class="small bg-white border rounded-3 p-3 fw-bold text-primary"
                     style="border-radius:14px;">
                  â€”
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</label>
                <select id="serviceCount" class="form-select">
                  <option value="1" selected>1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
              </div>
            </div>

            <!-- Additional Services UI -->
            <hr class="mt-4 mb-3"/>
            <div class="mt-2">
              <label class="form-label">Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <div id="additionalServicesWrap">
                <div class="text-muted small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©â€¦</div>
              </div>
              <div class="field-error" id="err-additionalServices" style="display:none"></div>
            </div>

            <div id="servicesLoading" class="load-overlay" aria-hidden="true">
              <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
              <strong>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øªâ€¦</strong>
            </div>
          </div>
        </section>

        <!-- 3) Time -->
        <section id="page3" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯">
          <h1>Ù…ØªÙ‰ ØªØ­Ø¨ Ù†Ø¬ÙŠÙƒØŸ</h1>
          <div class="card position-relative" id="timeCard">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label class="form-label" for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input id="date" type="date" class="form-control"/>
                <div class="field-error" id="err-date">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­</div>
              </div>
            </div>

            <div class="time-toolbar mt-3">
              <div>
                <label class="form-label" for="timeFilter">ÙÙ„ØªØ±Ø© Ø§Ù„ÙˆÙ‚Øª</label>
                <select id="timeFilter" class="form-select">
                  <option value="all" selected>ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</option>
                  <option value="morning">Ø§Ù„ØµØ¨Ø§Ø­ (06:00â€“11:00)</option>
                  <option value="afternoon">Ø§Ù„Ø¸Ù‡ÙŠØ±Ø© (11:00â€“16:00)</option>
                  <option value="evening">Ø§Ù„Ù…Ø³Ø§Ø¡ (16:00â€“21:00)</option>
                  <option value="night">Ù„ÙŠÙ„Ù‹Ø§ (21:00â€“23:59)</option>
                </select>
              </div>
            </div>

            <div class="position-relative mt-3">
              <div id="time-container" class="time-grid" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª"></div>
              <div id="timeLoading" class="load-overlay">
                <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
                <strong>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯â€¦</strong>
              </div>
            </div>
          </div>
        </section>

        <!-- 4) Contact -->
        <section id="page4" class="page" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„">
          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="name" class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                <input id="name" type="text" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" autocomplete="name"/>
                <div class="field-error" id="err-name">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="mobile" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input id="mobile" type="tel" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø®Ø§Øµ â€” Ù…Ø«Ø§Ù„ 5XXXXXXXX" autocomplete="tel"/>
                <div class="field-error" id="err-mobile">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­</div>

                <!-- ğŸ” OTP Controls (send + status) -->
                <div class="d-flex flex-wrap align-items-center gap-2 mt-2" id="otpControls" style="display:none;">
                  <button id="btnSendOtp" type="button" class="btn btn-sm btn-outline-primary" style="border-radius:999px; min-height:38px;">
                    Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
                  </button>
                  <span id="otpStatus" class="small text-muted">
                    Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.
                  </span>
                </div>

                <!-- ğŸ”¢ OTP Input + Verify -->
                <div class="row g-2 mt-2" id="otpVerifyRow" style="display:none;">
                  <div class="col-8 col-sm-6">
                    <input id="otpCode" type="tel" inputmode="numeric" maxlength="4"
                      class="form-control"
                      placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (4 Ø£Ø±Ù‚Ø§Ù…)"/>
                  </div>
                  <div class="col-4 col-sm-3 d-grid">
                    <button id="btnVerifyOtp" type="button" class="btn btn-success btn-sm" style="min-height:40px;">
                      ØªØ£ÙƒÙŠØ¯
                    </button>
                  </div>
                </div>
                <div class="field-error" id="err-otp" style="display:none;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØµØ­ÙŠØ­</div>
              </div>
            </div>
          </div>

          <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h1>
          <div class="card">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label" for="carBrand">Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© ğŸš˜</label>
                <select id="carBrand" style="width:100%"></select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="carName">Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input id="carName" type="text" class="form-control" placeholder="Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„/Ø§Ù„ÙØ¦Ø© â€” Ù…Ø«Ø§Ù„: S-ClassØŒ LX 570" autocomplete="off"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="plateNumber">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="plateNumber" type="text" inputmode="numeric" class="form-control" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù„ÙˆØ­Ø© â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ" autocomplete="off"/>
                <small id="plateHelp" class="text-muted d-block mt-1" style="opacity:.9">Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ÙŠØ³Ø§Ø¹Ø¯ ÙØ±ÙŠÙ‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ¨ØªÙƒ Ø¨Ø³Ø±Ø¹Ø©</small>
                <div class="field-error" id="err-plate" style="display:none"></div>
              </div>
              <input id="locationDescription" type="text" hidden/>
            </div>
          </div>
        </section>

        <!-- 5) Payment + Coupon -->
        <section id="page5" class="page" aria-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹">
          <h1>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h1>

          <!-- Dynamic payment methods will be injected here -->
          <div class="pay-grid" role="radiogroup" aria-label="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹" id="payGroup"></div>
          <div class="field-error" id="err-pay" style="text-align:center">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>

          <!-- Coupon block -->
          <div class="card mt-4" id="couponCard">
            <label for="couponCode" class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="input-group">
              <input id="couponCode" type="text" class="form-control" placeholder="Ù…Ø«Ø§Ù„: WELCOME10" autocomplete="off"/>
              <button id="applyCouponBtn" type="button" class="btn btn-outline-primary" style="min-width:120px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
            </div>
            <div id="couponMessage" class="small mt-2 text-muted">
              ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… Ø¥Ù† ÙˆØ¬Ø¯ØŒ ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨.
            </div>
          </div>
        </section>

        <!-- 6) Map -->
        <section id="page6" class="page" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <h1>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ù‚ÙˆÙ‚Ù„</h1>
          <div class="card">
            <div class="map-search">
              <input id="mapSearch" class="form-control" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø±Ø¬ØŒ Ø­ÙŠØŒ Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"/>
              <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <div id="googleMap"></div>
          </div>
          <div class="card text-center">
            <button id="show-my-location" class="btn btn-outline-primary" type="button">Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          </div>
          <small id="mapHint" class="text-muted d-block mt-2" style="text-align:center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ</small>
          <div class="field-error" id="err-map" style="text-align:center">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
        </section>

        <!-- 7) Done -->
        <section id="page7" class="page" aria-label="ØªÙ… Ø§Ù„Ø­Ø¬Ø²">
          <h1>Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ… ğŸŒŸ</h1>
          <div class="card text-center" style="max-width:720px">
            <p class="mb-3" style="color:#224652">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ÙƒÙ…ØŒ ÙˆØ³Ù†Ø¤ÙƒØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù‚Ø±ÙŠØ¨Ù‹Ø§.</p>

            <div id="thanks-summary" class="text-start mx-auto" style="max-width:520px">
              <div class="d-flex justify-content-between py-2 border-bottom"><span>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span><strong id="ts-area">â€”</strong></div>
              <div class="d-flex justify-content-between py-2 border-bottom"><span>Ø§Ù„Ø®Ø¯Ù…Ø©</span><strong id="ts-service">â€”</strong></div>
              <div class="d-flex justify-content-between py-2 border-bottom"><span>Ø§Ù„Ù…ÙˆØ¹Ø¯</span><strong id="ts-dt">â€”</strong></div>
              <div class="d-flex justify-content-between py-2"><span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><strong id="ts-pay">â€”</strong></div>
            </div>

            <div class="d-flex gap-2 justify-content-center mt-3 flex-wrap">
              <a id="ts-whatsapp" class="btn btn-success" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
              <button id="rebook" class="btn btn-primary" type="button" style="min-height:52px;font-weight:800;border-radius:12px;padding:12px 18px">ğŸ” Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- ğŸ Offers Modal Markup -->
  <div id="offersModal" class="offers-modal" aria-hidden="true">
    <div class="offers-backdrop"></div>
    <div class="offers-dialog" role="dialog" aria-modal="true" aria-labelledby="offersTitle">
      <div class="offers-header">
        <h2 id="offersTitle" class="offers-title">Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…</h2>
        <button type="button" class="offers-close" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø±ÙˆØ¶">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div id="offersFilters" class="offers-filters">
        <button type="button" class="offers-filter-chip active" data-type="all">Ø§Ù„ÙƒÙ„</button>
        <button type="button" class="offers-filter-chip active" data-type="image">ØµÙˆØ±</button>
        <button type="button" class="offers-filter-chip active" data-type="text">Ù†ØµÙˆØµ</button>
        <button type="button" class="offers-filter-chip active" data-type="coupon">ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</button>
      </div>
      <div id="offersList" class="offers-list">
        <div class="offers-empty text-muted small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶â€¦</div>
      </div>
    </div>
  </div>

  <footer id="siteFooter" class="sticky-nav" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ§Øª">
    <div class="footer-inner">
      <div class="footer-brand">
        <span>Ù†Ø­Ù„ â€¢ <a href="https://nahl.app" target="_blank" rel="noopener">Nahl.app</a></span>
        <div class="footer-social">
          <a href="https://wa.me/966509027172" target="_blank" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="https://www.instagram.com/nahl.app?igsh=ZmljaXNncGtudjJ2" target="_blank" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
          <a href="https://www.tiktok.com/@nahl.app?_t=ZS-8zgmzEQTSQW&_r=1" target="_blank" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
        </div>
      </div>

      <div class="footer-total">
        <span class="footer-total-label" id="footer-total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨:</span>
        <span class="footer-total-value" id="footer-total-value">â€”</span>
      </div>

      <div class="footer-actions">
        <button id="footer-prev" type="button" class="btn-footer hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="footer-next" type="button" class="btn-footer primary disabled" disabled>ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ø±Ø¶</button>
      
        <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø§Ù„ÙÙˆØªØ± -->
        <button id="footer-install-btn" type="button" class="btn-footer" style="display:none;">
          ğŸ“² ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        </button>
      
        <div id="footer-wait" class="">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨â€¦</span>
        </div>
      </div>
    </div>

    <!-- Ø²Ø± PWA Ø¹Ø§Ø¦Ù… Ù„Ù„Ø§ÙŠÙÙˆÙ†/Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ -->
    <button id="installPwaBtn"
      style="display:none; position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
            z-index:9999; padding:10px 18px; border-radius:999px;
            border:none; background:#027A93; color:#fff; font-weight:800;
            box-shadow:0 6px 18px rgba(0,0,0,.25);">
      ğŸ“² ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ NahlTime
    </button>
  </footer>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/intlTelInputWithUtils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function handleLogoError(img){
      const fallbacks = [
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20%20Soap/spong&Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/spong%26Soap%20-%20logo.png",
        "https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/Sponge%20%26%20Soap/logo.png",
        "https://dummyimage.com/180x54/027A93/ffffff.png&text=Sponge+%26+Soap"
      ];
      const i = Number(img.dataset.fidx||0);
      if (i < fallbacks.length){ img.dataset.fidx = String(i+1); img.src = fallbacks[i]; }
      else { img.style.display = 'none'; }
    }

    const APP_ID = '21eddbf5-efe5-4a5d-9134-b581717b17ff';

    const defaultLink2 = `https://b0sk44sswgc4kcswoo8sk0og.nahls.app/api/app/AM/general/${APP_ID}/form`;
    const RESERVE_URL_PRIMARY  = `${defaultLink2}/reserveAppointment`;
    const RESERVE_URL_FALLBACK = `${defaultLink2.replace(/\/form\/?$/,'')}/reserveAppointment`;

    const API_BASE = window.location.origin.replace(/\/$/, '');
    const ADDITIONAL_SERVICES_URL = `${API_BASE}/api/additional-services`;
    const COUPONS_API_URL         = `${API_BASE}/api/coupons/validate`;
    const AREA_BOUNDS_URL         = `${API_BASE}/api/area-bounds`;
    const PAYMENT_METHODS_URL     = `${API_BASE}/api/payment-methods`;
    const OFFERS_API_URL          = `${API_BASE}/api/offers`;

    /* ğŸ” OTP API endpoints (via proxy â†’ Code.gs â†’ Green API) */
    const OTP_REQUEST_URL         = `${API_BASE}/api/otp/request`;
    const OTP_VERIFY_URL          = `${API_BASE}/api/otp/verify`;

    /* ğŸ”„ Toggle OTP feature ON/OFF from here (no backend change required) */
    const OTP_ENABLED             = true;   // ğŸŸ¢ true = require OTP verify, ğŸ”´ false = skip OTP
    const OTP_CODE_LENGTH         = 4;
    const OTP_RESEND_SECONDS      = 60;

    let controllers = [];
    async function callContent2(path, cb, abortable=false, retries=3){
      let signal='';
      if(abortable){
        controllers.forEach(([c])=>c.abort()); controllers=[];
        const controller=new AbortController(); signal=controller.signal; controllers.push([controller,signal]);
      }
      try{
        await new Promise(r=>setTimeout(r, 200));
        const res=await fetch(defaultLink2+path,{method:'GET',redirect:'follow',...(abortable&&{signal}),cache:'no-store'});
        if(!res.ok){ if(retries>0) return callContent2(path,cb,abortable,retries-1); throw new Error('Network');}
        cb(await res.json());
      }catch(e){
        if(!String(e).includes('AbortError') && retries>0) setTimeout(()=>callContent2(path,cb,abortable,retries-1),600);
      }
    }
    async function postReservationTry(url, payload, contentType='text/plain;charset=UTF-8'){
      try{
        const res=await fetch(url,{method:'POST',mode:'cors',cache:'no-store',credentials:'omit',referrerPolicy:'no-referrer',headers:{'Content-Type':contentType,'Accept':'application/json'},body:JSON.stringify(payload)});
        const raw=await res.text(); let data=null; try{ data=JSON.parse(raw);}catch(_){}
        return {ok:res.ok,status:res.status,data,raw};
      }catch(err){ return {ok:false,status:0,error:String(err)} }
    }
    async function postReservation(payload){
      let r=await postReservationTry(RESERVE_URL_PRIMARY,payload,'text/plain;charset=UTF-8');
      if(!r.ok && (r.status===415||r.status===406||r.status===0)) r=await postReservationTry(RESERVE_URL_PRIMARY,payload,'application/json;charset=UTF-8');
      if(!r.ok && r.status===404) r=await postReservationTry(RESERVE_URL_FALLBACK,payload,'text/plain;charset=UTF-8');
      return r;
    }

    function showToast(type='info', msg=''){
      const wrap=document.getElementById('toastWrap');
      const div=document.createElement('div');
      div.style.minWidth='260px'; div.style.color='#fff'; div.style.padding='10px 14px';
      div.style.borderRadius='10px'; div.style.boxShadow='0 10px 28px rgba(11,38,48,.14)';
      div.style.background = type==='error' ? '#dc2626' : type==='success' ? '#16a34a' : '#0284c7';
      div.textContent=msg; wrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 180); }, 2400);
    }

    const DateTime=luxon.DateTime;
    const orderedPages=["page1","page2","page3","page4","page5","page6","page7"];
    const STEPS_LABELS=["Ø§Ù„ØªØ±Ø­ÙŠØ¨","Ø§Ù„Ø®Ø¯Ù…Ø©","Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","Ø§Ù„Ø¯ÙØ¹","Ø§Ù„Ù…ÙˆÙ‚Ø¹","ØªÙ…"];
    const STEPS_LABELS_EN=["Welcome","Service","Time","Details","Payment","Location","Done"];
    const PAGE_BACKGROUNDS={
      page1:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG1.jpg",
      page2:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG2.jpg",
      page3:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG3.jpg",
      page4:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG4.jpg",
      page5:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG5.jpg",
      page6:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG6.jpg",
      page7:"https://pdnmghkpepvsfaiqlafk.supabase.co/storage/v1/object/public/nahl%20assets/NahlTimeProFrom/NahlDemoBG7.jpg"
    };
    const STEP_GROUP_INDEX={page1:0,page2:1,page3:2,page4:3,page5:4,page6:5,page7:6};
    let selectedTime=null, servicesCache=null, categoriesCache=null, itiPhone=null, positionUrl="";
    let lastSelectedISO="";
    let isSubmitting=false;
    let currentTimeFilter='all';

    let additionalServicesList = [];

    let baseServicePrice = 0;
    let additionalServicesTotal = 0;

    let couponCodeApplied = '';
    let couponDiscountAmount = 0;
    let couponMeta = null;

    /* ğŸ” OTP state */
    let otpRequested = false;
    let otpVerified  = false;
    let otpLastSentAt = null;
    let otpCountdownTimer = null;

    const nForm={
      date:'',time:'',location:'',service:'',serviceCount:'1',serviceCat:'',
      customerM:'',customerN:'',paymentMethod:'',urlLocation:'',locationDescription:'', locale:'ar',
      additionalServicesIds:[],
      additionalServicesLabels:[],
      couponCode:''
    };

    // ğŸŒ Ø¶Ø¨Ø· Ø§Ù„Ù„ØºØ© Ù…Ù† Ø¨Ø§Ø±Ø§Ù…ØªØ± ?lang=en Ø£Ùˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ø±Ø¨ÙŠ
    (function initLocale() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        const langParam = (params.get('lang') || '').toLowerCase();
        if (langParam === 'en') {
          nForm.locale = 'en';
          document.documentElement.lang = 'en';
          document.documentElement.dir  = 'ltr';
        } else {
          nForm.locale = 'ar';
          document.documentElement.lang = 'ar';
          document.documentElement.dir  = 'rtl';
        }
      } catch(e) {
        console.warn('Locale init failed', e);
      }
    })();

    function isEnglishLocale(){
      const localeRaw = (nForm.locale || document.documentElement.lang || 'ar').toLowerCase();
      return localeRaw.startsWith('en');
    }

    function getServiceDescription(s) {
      const isEnglish = isEnglishLocale();
      if (isEnglish) {
        return (s.TS_service_descriptionEN || s.TS_service_descriptionAR || '').trim();
      } else {
        return (s.TS_service_descriptionAR || s.TS_service_descriptionEN || '').trim();
      }
    }

    function formatServicePrice(priceRaw) {
      if (priceRaw === null || priceRaw === undefined || priceRaw === '') return '';
      const num = Number(priceRaw);
      const isEnglish = isEnglishLocale();

      if (!isFinite(num)) {
        return isEnglish
          ? `${priceRaw} SAR (incl. VAT)`
          : `${priceRaw} Ø±.Ø³ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)`;
      }

      const formatter = new Intl.NumberFormat(isEnglish ? 'en-SA' : 'ar-SA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const formatted = formatter.format(num);
      return isEnglish
        ? `${formatted} SAR (incl. VAT)`
        : `${formatted} Ø±.Ø³ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)`;
    }

    function formatTotalAmount(value){
      if (value === null || value === undefined || isNaN(value)) return 'â€”';
      const isEnglish = isEnglishLocale();
      const formatter = new Intl.NumberFormat(isEnglish ? 'en-SA' : 'ar-SA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const formatted = formatter.format(value);
      return isEnglish ? `${formatted} SAR` : `${formatted} Ø±.Ø³`;
    }

    function getCarCount(){
      const raw = $('#serviceCount').val() || '1';
      const n = parseInt(raw, 10);
      return (!isNaN(n) && n > 0) ? n : 1;
    }

    function getOrderSubtotal(){
      const carCount = getCarCount();
      const perCar = (Number(baseServicePrice) || 0) + (Number(additionalServicesTotal) || 0);
      return perCar * carCount;
    }

    function updateFooterTotal(){
      const subtotal = getOrderSubtotal();
      const discount = Math.min(subtotal, Number(couponDiscountAmount) || 0);
      const finalTotal = Math.max(0, subtotal - discount);
      const el = document.getElementById('footer-total-value');
      if (el){
        el.textContent = formatTotalAmount(finalTotal);
      }
    }

    function setPageBackground(id){ document.documentElement.style.setProperty('--page-bg', `url("${PAGE_BACKGROUNDS[id]||PAGE_BACKGROUNDS.page1}")`); }

    function showPage(idx){
      const cur=document.querySelector('.page.active');
      const next=document.getElementById(orderedPages[idx]); if(!next||cur===next) return;
      if(cur && cur.id==='page1') stopWelcomeDeck();
      if(cur){ cur.classList.remove('active'); cur.classList.add('exit'); }
      next.style.display='flex';
      requestAnimationFrame(()=>{ next.classList.add('active'); setTimeout(()=>{ if(cur){cur.classList.remove('exit'); cur.style.display='none';} }, 240); });

      syncProgress(idx);
      setPageBackground(next.id);
      renderSummary(next.id);
      updateNextAvailability();
      if(next.id==='page1') startWelcomeDeck();
      if(next.id==='page6'){
        requestAreaBoundsForCurrentArea();
      }
    }
    function getActiveIndex(){ const id=document.querySelector('.page.active')?.id; return Math.max(0, orderedPages.indexOf(id)); }
    function syncProgress(i){
      const pct=((i+1)/orderedPages.length)*100;
      document.getElementById('miniBarFill').style.width=pct+'%';

      const isEn = isEnglishLocale();
      const labels = isEn ? STEPS_LABELS_EN : STEPS_LABELS;
      document.getElementById('miniStepTitle').textContent=labels[Math.min(i,labels.length-1)];

      const prev=document.getElementById('footer-prev');
      const next=document.getElementById('footer-next');
      const wait=document.getElementById('footer-wait');
      const onThanks=(orderedPages[i]==='page7');
      prev.classList.toggle('hidden', i===0 || onThanks);
      next.classList.toggle('hidden', onThanks);
      wait.classList.remove('show');

      if (isEn){
        next.textContent = (i===0) ? 'Skip intro' : 'Next';
      } else {
        next.textContent = (i===0) ? 'ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ø±Ø¶' : 'Ø§Ù„ØªØ§Ù„ÙŠ';
      }
    }

    function setLoadingTimes(on){ document.getElementById('timeLoading').classList.toggle('show', !!on); }
    function setLoadingServices(on){ document.getElementById('servicesLoading').classList.toggle('show', !!on); }

    function isSpecialPlate(num){
      if(!/^\d+$/.test(num) || num.length < 3) return false;
      const same = /^(\d)\1+$/.test(num);
      const asc  = ('01234567890123456789').includes(num);
      const desc = ('98765432109876543210').includes(num);
      const pal  = num === num.split('').reverse().join('');
      const pairRepeat = (num.length%2===0) && /^(\d{2})\1+$/.test(num);
      return same || asc || desc || pal || pairRepeat;
    }
    function updatePlateHint(){
      const raw = ($('#plateNumber').val()||'');
      const v   = raw.replace(/\D/g,'');

      $('#plateNumber').val(v);
      const txt = v
        ? (isSpecialPlate(v) ? 'Ø±Ù‚Ù… Ù…Ù…ÙŠØ² ğŸ‘Œ â€” Ù…Ù…ØªØ§Ø² Ù„Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø³Ø±ÙŠØ¹.' : 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ÙŠØ³Ø§Ø¹Ø¯ ÙØ±ÙŠÙ‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ¨ØªÙƒ.')
        : 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ÙŠØ³Ø§Ø¹Ø¯ ÙØ±ÙŠÙ‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ¨ØªÙƒ';

      $('#plateHelp').text(txt);
      const pe=document.getElementById('err-plate'); if(pe) pe.style.display='none';
    }

    function renderSummary(currentId){
      const wrap=document.getElementById('summaryChips'); if(!wrap) return;
      const activeId=currentId || (document.querySelector('.page.active')?.id) || 'page1';
      const currGroup=STEP_GROUP_INDEX[activeId] ?? 0;

      wrap.style.display = currGroup === 0 ? 'none' : 'flex';
      if(currGroup===0){ wrap.innerHTML=''; return; }

      const areaTxt=$('#area').find(':selected').text()||'';
      const srvTxt=$('#service').find(':selected').text()||'';
      const dt=nForm.date ? DateTime.fromISO(nForm.date).toFormat('d LLL yyyy') : '';
      const tm=nForm.time||'';
      const pay=(nForm.paymentMethod||'');
      const locOk=!!positionUrl;
      const extras=(nForm.additionalServicesLabels||[]).join('ØŒ ');
      const couponTxt = couponCodeApplied ? couponCodeApplied : '';

      const chips=[
        {i:'fa-location-dot',t:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',v:areaTxt,g:1},
        {i:'fa-screwdriver-wrench',t:'Ø§Ù„Ø®Ø¯Ù…Ø©',v:srvTxt,g:1},
        {i:'fa-plus',t:'Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©',v:extras,g:1},
        {i:'fa-ticket',t:'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',v:couponTxt,g:4},
        {i:'fa-clock',t:'Ø§Ù„Ù…ÙˆØ¹Ø¯',v:(dt&&tm)?`${dt} â€¢ ${tm}`:'',g:2},
        {i:'fa-credit-card',t:'Ø§Ù„Ø¯ÙØ¹',v:(pay?pay.toUpperCase():''),g:4},
        {i:'fa-map-pin',t:'Ø§Ù„Ù…ÙˆÙ‚Ø¹',v:(locOk?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯':''),g:5},
      ];

      wrap.innerHTML='';
      chips.filter(c=>c.v && c.g<=currGroup).forEach(c=>{
        const el=document.createElement('div');
        el.className='chip'+(c.g===currGroup?' current':'' );
        el.innerHTML=`<i class="fa-solid ${c.i}"></i><span class="title">${c.t}:</span><span class="value">${c.v}</span>`;
        wrap.appendChild(el);
      });
    }

    let deckTimers=[]; let deckIndex=0; let deckRunning=false;
    const SLIDE_MS=2600; const GAP_MS=220;
    function startWelcomeDeck(){
      const deck=document.getElementById('pptDeck'); if(!deck) return;
      const slides=[...deck.querySelectorAll('.ppt-slide')];
      const dotsWrap=document.getElementById('pptDots');
      dotsWrap.innerHTML=slides.map((_,i)=>`<span class="ppt-dot${i===0?' active':''}"></span>`).join('');
      const dots=[...dotsWrap.children];

      const setActive=(i,ex=-1)=>{
        slides.forEach((s,idx)=>{ s.classList.remove('is-active','is-exiting'); if(idx===i){s.classList.add('is-active'); s.style.zIndex=2;} else if(idx===ex){s.classList.add('is-exiting'); s.style.zIndex=1;} else{s.style.zIndex=0;} });
        dots.forEach((d,idx)=>d.classList.toggle('active', idx===i));
      };
      deckRunning=true; deckIndex=0; setActive(0,-1);
      const advance=()=>{ if(!deckRunning) return; const prev=deckIndex; deckIndex++; if(deckIndex>=slides.length){ stopWelcomeDeck(); showPage(1); return; } setActive(deckIndex,prev); schedule(); };
      const schedule=()=>{ deckTimers.push(setTimeout(advance, SLIDE_MS+GAP_MS)); };
      schedule();
    }
    function stopWelcomeDeck(){ deckRunning=false; deckTimers.forEach(clearTimeout); deckTimers=[]; }

    function parseTimeToLuxon(raw){
      let t=DateTime.fromISO(String(raw||'').trim(),{setZone:true});
      if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'HH:mm:ss',{setZone:true});
      if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm a',{setZone:true});
      if(!t.isValid) t=DateTime.fromFormat(String(raw||''),'H:mm',{setZone:true});
      return t.isValid?t:null;
    }
    function normalizeAvailability(r){
      const s=String(r.TS_status||r.status||r.TS_appointment_status||'').toLowerCase();
      const f=(typeof r.isAvailable==='boolean')?r.isAvailable:undefined;
      const b=Number(r.TS_booked ?? r.booked); const c=Number(r.TS_capacity ?? r.capacity);
      let rem=Number(r.TS_remaining ?? r.remaining);
      if(!Number.isFinite(rem)&&Number.isFinite(c)&&Number.isFinite(b)) rem=c-b;
      const open=f===true||['available','open','free','empty','vacant','canceled'].includes(s)||(Number.isFinite(rem)?rem>0:(f!==false&&!s));
      return {looksOpen:open,remaining:rem};
    }

    let dayTimes=[]; let timesLoaded=false;
    function timeInMins(h, m){ return (h*60)+m }
    function passesFilter(mins){
      if(currentTimeFilter==='all') return true;
      if(currentTimeFilter==='morning')   return mins>=timeInMins(6,0)  && mins<timeInMins(11,0);
      if(currentTimeFilter==='afternoon') return mins>=timeInMins(11,0) && mins<timeInMins(16,0);
      if(currentTimeFilter==='evening')   return mins>=timeInMins(16,0) && mins<timeInMins(21,0);
      if(currentTimeFilter==='night')     return mins>=timeInMins(21,0) && mins<timeInMins(24,0);
      return true;
    }

    function fetchTimesForSelectedDate(){
      const dateEl=document.getElementById('date');
      const timeContainer=document.getElementById('time-container');
      const loc=$('#area').val()||''; const srv=$('#service').val()||'';

      if (!dateEl || !timeContainer) return;

      const dateVal = dateEl.value;
      nForm.date = dateVal || '';

      timeContainer.innerHTML = '';
      selectedTime = null;
      dayTimes = [];
      timesLoaded = false;
      updateNextAvailability();

      if (!dateVal || !loc || !srv) return;

      setLoadingTimes(true);

      // ğŸ” Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù€ API Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
      // Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ: /times?appid=&date=&area=&service=
      const url = `${API_BASE}/api/times?appid=${encodeURIComponent(APP_ID)}&date=${encodeURIComponent(dateVal)}&area=${encodeURIComponent(loc)}&service=${encodeURIComponent(srv)}`;

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          // Ø´ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ØªÙˆÙ‚Ù‘ÙØ¹:
          // { ok:true, times:[ { label:"10:00 Øµ", value:"10:00", status:"available" }, ...] }
          const list = (data && Array.isArray(data.times)) ? data.times : null;

          if (!list || !list.length) {
            dayTimes = [];
          } else {
            dayTimes = list.map(t => {
              const label = t.label || t.time || '';
              const isoRaw = t.iso || '';
              const iso = isoRaw || `${dateVal}T${(t.value || '10:00')}:00`;
              return {
                label,
                iso,
                raw: t
              };
            });
          }

          timesLoaded = true;
          renderTimeOptions();
        })
        .catch(err => {
          console.warn('Failed to load times, using fallback', err);
          // â° Ø£ÙˆÙ‚Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ø§Ù„Ù€ API Ù…Ø§ Ø§Ø´ØªØºÙ„
          const fallback = ['09:00', '10:00', '11:00', '13:00', '15:00', '17:00', '19:00'];
          dayTimes = fallback.map(t => ({
            label: t,
            iso: `${dateVal}T${t}:00`,
            raw: { status: 'available' }
          }));
          timesLoaded = true;
          renderTimeOptions();
        })
        .finally(() => setLoadingTimes(false));
    }

    function renderTimeOptions() {
      const timeContainer = document.getElementById('time-container');
      if (!timeContainer) return;
      timeContainer.innerHTML = '';

      if (!timesLoaded || !dayTimes.length) {
        timeContainer.innerHTML = '<div class="text-center text-muted w-100 py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
        return;
      }

      const isEn = isEnglishLocale();

      dayTimes.forEach((slot, idx) => {
        const dt = parseTimeToLuxon(slot.iso);
        if (!dt) return;

        const mins = dt.hour * 60 + dt.minute;
        if (!passesFilter(mins)) return;

        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'time-option';
        div.setAttribute('role', 'radio');
        div.setAttribute('aria-checked', selectedTime === slot.iso ? 'true' : 'false');
        div.dataset.iso = slot.iso;
        div.dataset.label = slot.label || dt.toFormat('HH:mm');

        const label = slot.label || dt.toFormat(isEn ? 'HH:mm' : 'HH:mm');
        const period = dt.toFormat(isEn ? 'a' : 'a');
        div.innerHTML = `<div>${label}</div><small class="text-muted">${period}</small>`;

        div.addEventListener('click', () => {
          selectTime(slot.iso, label);
        });

        timeContainer.appendChild(div);
      });

      if (!timeContainer.children.length) {
        timeContainer.innerHTML = '<div class="text-center text-muted w-100 py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>';
      }
    }

    function selectTime(iso, label) {
      selectedTime = iso;
      nForm.time = label || '';

      $('#time-container .time-option').attr('aria-checked', 'false');
      $('#time-container .time-option').each(function () {
        if (this.dataset.iso === iso) {
          this.setAttribute('aria-checked', 'true');
        }
      });

      renderSummary('page3');
      updateNextAvailability();
    }

    function onTimeFilterChange() {
      const sel = document.getElementById('timeFilter');
      currentTimeFilter = sel ? sel.value || 'all' : 'all';
      renderTimeOptions();
    }

    /* ğŸ§© Additional Services (Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©) */

    function loadAdditionalServices() {
      const wrap = document.getElementById('additionalServicesWrap');
      if (!wrap) return;

      wrap.innerHTML = '<div class="text-muted small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©â€¦</div>';

      const area = $('#area').val() || '';
      const url = `${ADDITIONAL_SERVICES_URL}?appid=${encodeURIComponent(APP_ID)}&area=${encodeURIComponent(area)}`;

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          // Ø´ÙƒÙ„ Ù…ØªÙˆÙ‚Ù‘ÙØ¹:
          // { ok:true, services:[ {id,name,price,perCar} ] }
          const list = (data && Array.isArray(data.services)) ? data.services : [];
          additionalServicesList = list;
          renderAdditionalServices(list);
        })
        .catch(err => {
          console.warn('Additional services load error', err);
          additionalServicesList = [];
          wrap.innerHTML = '<div class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
        });
    }

    function renderAdditionalServices(list) {
      const wrap = document.getElementById('additionalServicesWrap');
      if (!wrap) return;

      if (!list || !list.length) {
        wrap.innerHTML = '<div class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
        return;
      }

      const isEn = isEnglishLocale();
      wrap.innerHTML = '';

      const grid = document.createElement('div');
      grid.className = 'row g-2';

      list.forEach(item => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6';

        const id = String(item.id || item.code || item.name || Math.random()).replace(/\s+/g, '_');

        const price = Number(item.price) || 0;
        const perCar = !!item.perCar;

        const priceText = isEn
          ? `${price || 0} SAR${perCar ? ' / car' : ''}`
          : `${price || 0} Ø±.Ø³${perCar ? ' / Ø³ÙŠØ§Ø±Ø©' : ''}`;

        col.innerHTML = `
          <label class="d-flex align-items-center gap-2 bg-white border rounded-3 px-2 py-1" style="border-radius:14px;">
            <input type="checkbox"
                   class="form-check-input mt-0"
                   data-id="${item.id}"
                   data-name="${item.name || ''}"
                   data-price="${price}"
                   data-per-car="${perCar ? '1' : '0'}"
                   style="width:18px;height:18px;">
            <span class="flex-grow-1 small">
              <div class="fw-bold mb-1">${item.name || ''}</div>
              <div class="text-muted">${priceText}</div>
            </span>
          </label>
        `;

        grid.appendChild(col);
      });

      wrap.appendChild(grid);

      // on change
      wrap.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', () => {
          updateAdditionalServicesTotal();
          renderSummary('page2');
        });
      });
    }

    function updateAdditionalServicesTotal() {
      const wrap = document.getElementById('additionalServicesWrap');
      if (!wrap) return;

      let totalPerCar = 0;
      const ids = [];
      const labels = [];

      wrap.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        if (!chk.checked) return;
        const price = Number(chk.dataset.price || 0);
        const perCar = chk.dataset.perCar === '1';
        const name = chk.dataset.name || '';
        ids.push(chk.dataset.id || '');
        labels.push(name);

        if (perCar) totalPerCar += price;
        else totalPerCar += price; // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨Ø› ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
      });

      additionalServicesTotal = totalPerCar;
      nForm.additionalServicesIds = ids;
      nForm.additionalServicesLabels = labels;

      const servicePriceLabel = document.getElementById('servicePrice');
      if (servicePriceLabel) {
        const subtotal = getOrderSubtotal();
        servicePriceLabel.textContent = formatTotalAmount(subtotal);
      }

      updateFooterTotal();
    }

    /* ğŸ’³ Payment Methods */

    function loadPaymentMethods() {
      const url = `${PAYMENT_METHODS_URL}?appid=${encodeURIComponent(APP_ID)}`;

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          // Ø´ÙƒÙ„ Ù…ØªÙˆÙ‚Ù‘ÙØ¹:
          // { ok:true, methods:[ { id, label, logoUrl, active, priority } ] }
          const list = (data && Array.isArray(data.methods)) ? data.methods : [];
          renderPaymentMethods(list);
        })
        .catch(err => {
          console.warn('Payment methods error', err);
          // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø³ÙŠØ·
          renderPaymentMethods([
            { id: 'cash', label: 'Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„', logoUrl: '', active: true, priority: 2 },
            { id: 'online', label: 'Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ø±Ø§Ø¨Ø· ÙØ§ØªÙˆØ±Ø©)', logoUrl: '', active: true, priority: 1 }
          ]);
        });
    }

    function renderPaymentMethods(methods) {
      const wrap = document.getElementById('payGroup');
      if (!wrap) return;

      const isEn = isEnglishLocale();
      wrap.innerHTML = '';

      const arr = (methods || []).filter(m => m.active !== false);
      if (!arr.length) {
        wrap.innerHTML = '<div class="text-center text-muted w-100 py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
        return;
      }

      arr.sort((a, b) => (a.priority || 10) - (b.priority || 10));

      arr.forEach(m => {
        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'pay-card';
        div.setAttribute('role', 'radio');
        div.setAttribute('aria-checked', (nForm.paymentMethod === m.id) ? 'true' : 'false');
        div.dataset.id = m.id;

        const label = m.label || (isEn ? 'Payment method' : 'Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹');
        let inner = `<strong>${label}</strong>`;
        if (m.logoUrl) {
          inner = `<img src="${m.logoUrl}" alt="${label}">`;
        }
        div.innerHTML = inner;

        div.addEventListener('click', () => {
          document.querySelectorAll('#payGroup .pay-card').forEach(x => x.setAttribute('aria-checked', 'false'));
          div.setAttribute('aria-checked', 'true');
          nForm.paymentMethod = m.id;
          renderSummary('page5');
          updateNextAvailability();
        });

        wrap.appendChild(div);
      });
    }

    /* ğŸ· Coupon (ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ…) */

    function resetCouponState() {
      couponCodeApplied = '';
      couponDiscountAmount = 0;
      couponMeta = null;
      const msg = document.getElementById('couponMessage');
      if (msg) {
        msg.classList.remove('text-success', 'text-danger');
        msg.classList.add('text-muted');
        msg.textContent = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… Ø¥Ù† ÙˆØ¬Ø¯ØŒ ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨.';
      }
      updateFooterTotal();
    }

    function validateCouponAndApply() {
      const input = document.getElementById('couponCode');
      const msg = document.getElementById('couponMessage');
      if (!input || !msg) return;

      const codeRaw = (input.value || '').trim();
      if (!codeRaw) {
        resetCouponState();
        return;
      }

      const subtotal = getOrderSubtotal();
      if (!subtotal || subtotal <= 0) {
        msg.classList.remove('text-success', 'text-muted');
        msg.classList.add('text-danger');
        msg.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†.';
        return;
      }

      const code = codeRaw.toUpperCase();
      msg.classList.remove('text-success', 'text-danger', 'text-muted');
      msg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†â€¦';

      const url = `${COUPONS_API_URL}?appid=${encodeURIComponent(APP_ID)}&code=${encodeURIComponent(code)}&amount=${encodeURIComponent(subtotal)}`;

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data || data.ok === false) {
            couponCodeApplied = '';
            couponDiscountAmount = 0;
            couponMeta = null;
            msg.classList.remove('text-success', 'text-muted');
            msg.classList.add('text-danger');
            msg.textContent = (data && data.message) ? data.message : 'ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ.';
            updateFooterTotal();
            return;
          }

          const discount = Number(data.discount || 0);
          couponCodeApplied = code;
          couponDiscountAmount = discount;
          couponMeta = data.coupon || null;

          msg.classList.remove('text-danger', 'text-muted');
          msg.classList.add('text-success');

          const finalAfter = Math.max(0, subtotal - discount);
          msg.textContent = `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­! Ø®ØµÙ… ${discount.toFixed(2)} Ø±.Ø³ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ${finalAfter.toFixed(2)} Ø±.Ø³.`;

          nForm.couponCode = code;
          renderSummary('page5');
          updateFooterTotal();
        })
        .catch(err => {
          console.warn('Coupon validate error', err);
          msg.classList.remove('text-success', 'text-muted');
          msg.classList.add('text-danger');
          msg.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.';
        });
    }

    /* ğŸ Offers Modal (Ø¹Ø±ÙˆØ¶) â€” Multi-App via App ID + Offers sheet */

    let offersData = [];
    const offersFilterState = {
      image: true,
      text: true,
      coupon: true
    };

    function loadOffersForApp(contextPage = 'welcome') {
      const url = `${OFFERS_API_URL}?appid=${encodeURIComponent(APP_ID)}&page=${encodeURIComponent(contextPage)}`;

      const listEl = document.getElementById('offersList');
      if (listEl) {
        listEl.innerHTML = '<div class="offers-empty text-muted small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶â€¦</div>';
      }

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          // Ø´ÙƒÙ„ Ù…ØªÙˆÙ‚Ù‘ÙØ¹ Ù…Ù† Ø§Ù„Ù€ API (Ù…Ù† Sheet Offers):
          // headers:
          // Offer ID, App ID, Title AR, Title EN, Body AR, Body EN, Type,
          // Image URL, Coupon Code, Button Label AR, Button Label EN, Button URL,
          // Show On Pages, Start Date, End Date, Active, Priority
          // response:
          // { ok:true, offers:[ { "Offer ID":"...", "App ID":"...", "Title AR":"...", ... } ] }
          const arr = (data && Array.isArray(data.offers)) ? data.offers : [];
          offersData = arr;
          renderOffersList();
        })
        .catch(err => {
          console.warn('Offers error', err);
          if (listEl) {
            listEl.innerHTML = '<div class="offers-empty text-muted small">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>';
          }
        });
    }

    function getOfferType(offer) {
      const raw = String(offer['Type'] || offer.type || '').toLowerCase();
      if (raw.includes('image')) return 'image';
      if (raw.includes('coupon')) return 'coupon';
      return 'text';
    }

    function isOfferActiveNow(offer) {
      const activeRaw = offer['Active'] ?? offer.active;
      const active = (activeRaw === true) ||
        String(activeRaw).toLowerCase() === 'true' ||
        String(activeRaw).toLowerCase() === 'yes' ||
        String(activeRaw).toLowerCase() === '1';

      if (!active) return false;

      const now = DateTime.now().startOf('day');
      const sRaw = offer['Start Date'] || offer['StartDate'] || offer.startDate || '';
      const eRaw = offer['End Date'] || offer['EndDate'] || offer.endDate || '';

      if (sRaw) {
        const s = DateTime.fromISO(String(sRaw), { zone: 'utc' }).startOf('day');
        if (s.isValid && now < s) return false;
      }
      if (eRaw) {
        const e = DateTime.fromISO(String(eRaw), { zone: 'utc' }).startOf('day');
        if (e.isValid && now > e) return false;
      }
      return true;
    }

    function getOfferTitle(offer) {
      const isEn = isEnglishLocale();
      const ar = offer['Title AR'] || offer.titleAr || '';
      const en = offer['Title EN'] || offer.titleEn || '';
      return (isEn ? (en || ar) : (ar || en)) || '';
    }

    function getOfferBody(offer) {
      const isEn = isEnglishLocale();
      const ar = offer['Body AR'] || offer.bodyAr || '';
      const en = offer['Body EN'] || offer.bodyEn || '';
      return (isEn ? (en || ar) : (ar || en)) || '';
    }

    function getOfferButtonLabel(offer) {
      const isEn = isEnglishLocale();
      const ar = offer['Button Label AR'] || offer.buttonLabelAr || '';
      const en = offer['Button Label EN'] || offer.buttonLabelEn || '';
      if (!ar && !en) return isEn ? 'View offer' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
      return isEn ? (en || ar) : (ar || en);
    }

    function applyOfferCoupon(code) {
      if (!code) return;
      const input = document.getElementById('couponCode');
      if (input) {
        input.value = code;
      }
      validateCouponAndApply();
      closeOffersModal();
      // Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ùˆ Ø­Ø§Ø¨:
      const idx = orderedPages.indexOf('page5');
      if (idx > -1) {
        showPage(idx);
      }
    }

    function renderOffersList() {
      const listEl = document.getElementById('offersList');
      if (!listEl) return;

      listEl.innerHTML = '';

      const filtered = offersData
        .filter(isOfferActiveNow)
        .sort((a, b) => {
          const pa = Number(a['Priority'] || a.priority || 999);
          const pb = Number(b['Priority'] || b.priority || 999);
          return pa - pb;
        })
        .filter(o => {
          const t = getOfferType(o);
          if (t === 'image' && !offersFilterState.image) return false;
          if (t === 'text' && !offersFilterState.text) return false;
          if (t === 'coupon' && !offersFilterState.coupon) return false;
          return true;
        });

      if (!filtered.length) {
        listEl.innerHTML = '<div class="offers-empty text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>';
        return;
      }

      filtered.forEach(o => {
        const type = getOfferType(o);
        const title = getOfferTitle(o);
        const body = getOfferBody(o);
        const imgUrl = o['Image URL'] || o.imageUrl || '';
        const coupon = o['Coupon Code'] || o.couponCode || '';
        const btnUrl = o['Button URL'] || o.buttonUrl || '';
        const btnLabel = getOfferButtonLabel(o);

        const card = document.createElement('div');
        card.className = 'offer-card';

        const titleHtml = title ? `<h3 class="offer-title">${title}</h3>` : '';
        const bodyHtml = body ? `<p class="offer-body">${body}</p>` : '';

        let extraTop = '';
        if (coupon) {
          extraTop = `
            <span class="offer-coupon-chip">
              <i class="fa-solid fa-ticket"></i>
              <span>${coupon}</span>
            </span>
          `;
        }

        let datesHtml = '';
        const sRaw = o['Start Date'] || o.startDate || '';
        const eRaw = o['End Date'] || o.endDate || '';
        if (sRaw || eRaw) {
          datesHtml = `<span class="offer-dates">${sRaw || ''} - ${eRaw || ''}</span>`;
        }

        card.innerHTML = `
          ${titleHtml}
          ${bodyHtml}
          <div class="offer-tag-row">
            <span class="offer-tag">${type === 'image' ? 'Ø¹Ø±Ø¶ Ø¨ØµÙˆØ±Ø©' : type === 'coupon' ? 'Ø¹Ø±Ø¶ ÙƒÙˆØ¨ÙˆÙ†' : 'Ø¹Ø±Ø¶ Ù†ØµÙŠ'}</span>
            ${datesHtml || ''}
          </div>
          ${imgUrl ? `<img src="${imgUrl}" alt="${title || ''}" class="offer-image">` : ''}
          ${extraTop}
        `;

        const btnRow = document.createElement('div');
        btnRow.className = 'd-flex justify-content-between align-items-center mt-1 flex-wrap gap-2';

        if (coupon) {
          const btnApply = document.createElement('button');
          btnApply.type = 'button';
          btnApply.className = 'offer-apply-btn';
          btnApply.innerHTML = `<i class="fa-solid fa-ticket"></i><span>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</span>`;
          btnApply.addEventListener('click', () => applyOfferCoupon(coupon));
          btnRow.appendChild(btnApply);
        }

        if (btnUrl) {
          const btnLink = document.createElement('button');
          btnLink.type = 'button';
          btnLink.className = 'offer-apply-btn';
          btnLink.innerHTML = `<i class="fa-solid fa-up-right-from-square"></i><span>${btnLabel}</span>`;
          btnLink.addEventListener('click', () => {
            window.open(btnUrl, '_blank', 'noopener');
          });
          btnRow.appendChild(btnLink);
        }

        if (btnRow.children.length) {
          card.appendChild(btnRow);
        }

        listEl.appendChild(card);
      });
    }

    function openOffersModal() {
      const modal = document.getElementById('offersModal');
      if (!modal) return;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('offers-open');

      if (!offersData || !offersData.length) {
        loadOffersForApp('welcome');
      }
    }

    function closeOffersModal() {
      const modal = document.getElementById('offersModal');
      if (!modal) return;
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('offers-open');
    }

    /* ğŸ“ Area bounds â†’ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© */

    function requestAreaBoundsForCurrentArea() {
      if (!window.google || !window._map) return;
      const areaName = $('#area').find(':selected').text() || '';
      if (!areaName) return;

      const url = `${AREA_BOUNDS_URL}?appid=${encodeURIComponent(APP_ID)}&area=${encodeURIComponent(areaName)}`;

      fetch(url, { cache: 'no-store' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          // Ø´ÙƒÙ„ Ù…ØªÙˆÙ‚Ù‘ÙØ¹: { ok:true, center:{lat,lng}, zoom:13 }
          if (!data || !data.center) return;
          const center = new google.maps.LatLng(data.center.lat, data.center.lng);
          window._map.setCenter(center);
          window._map.setZoom(data.zoom || 13);
          if (window._marker) {
            window._marker.setPosition(center);
          }
        })
        .catch(err => console.warn('Area bounds error', err));
    }

    /* ğŸ” OTP Helpers (ÙˆØ§ØªØ³Ø§Ø¨) */

    function updateOtpUI() {
      const controls = document.getElementById('otpControls');
      const row = document.getElementById('otpVerifyRow');
      const status = document.getElementById('otpStatus');

      if (!OTP_ENABLED) {
        if (controls) controls.style.display = 'none';
        if (row) row.style.display = 'none';
        return;
      }

      const mobileVal = ($('#mobile').val() || '').trim();
      if (!mobileVal) {
        if (controls) controls.style.display = 'none';
        if (row) row.style.display = 'none';
        return;
      }

      if (otpVerified) {
        if (controls) controls.style.display = 'flex';
        if (row) row.style.display = 'none';
        if (status) {
          status.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ğŸ‰';
        }
        return;
      }

      if (controls) controls.style.display = 'flex';
      if (row) row.style.display = otpRequested ? 'flex' : 'none';
      if (status) {
        status.textContent = otpRequested
          ? 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø£Ø¯Ù†Ø§Ù‡.'
          : 'Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù…Ùƒ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.';
      }
    }

    function startOtpCountdown() {
      const btn = document.getElementById('btnSendOtp');
      const status = document.getElementById('otpStatus');
      if (!btn) return;

      if (otpCountdownTimer) clearInterval(otpCountdownTimer);

      let remaining = OTP_RESEND_SECONDS;
      btn.disabled = true;

      const update = () => {
        if (remaining <= 0) {
          clearInterval(otpCountdownTimer);
          btn.disabled = false;
          btn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯';
          if (status && !otpVerified) {
            status.textContent = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠØµÙ„Ùƒ.';
          }
          return;
        }
        btn.textContent = `Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ (${remaining})`;
        remaining--;
      };

      update();
      otpCountdownTimer = setInterval(update, 1000);
    }

    function sendOtp() {
      const mobileVal = ($('#mobile').val() || '').trim();
      const err = document.getElementById('err-otp');

      if (!mobileVal) {
        if (err) {
          err.style.display = 'block';
          err.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹';
        }
        return;
      }
      if (err) err.style.display = 'none';

      const payload = {
        appId: APP_ID,
        mobile: mobileVal
      };

      otpRequested = true;
      otpVerified = false;
      updateOtpUI();
      startOtpCountdown();

      fetch(OTP_REQUEST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data || data.ok === false) {
            showToast('error', (data && data.message) || 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.');
          } else {
            showToast('success', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ ğŸ“²');
          }
        })
        .catch(err2 => {
          console.warn('OTP request error', err2);
          showToast('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚.');
        });
    }

    function verifyOtp() {
      const code = ($('#otpCode').val() || '').trim();
      const mobileVal = ($('#mobile').val() || '').trim();
      const err = document.getElementById('err-otp');

      if (!code || code.length !== OTP_CODE_LENGTH) {
        if (err) {
          err.style.display = 'block';
          err.textContent = `ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ù…Ù† ${OTP_CODE_LENGTH} Ø£Ø±Ù‚Ø§Ù….`;
        }
        return;
      }
      if (err) err.style.display = 'none';

      const payload = {
        appId: APP_ID,
        mobile: mobileVal,
        code
      };

      fetch(OTP_VERIFY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data || data.ok === false) {
            if (err) {
              err.style.display = 'block';
              err.textContent = (data && data.message) || 'ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ.';
            }
            otpVerified = false;
          } else {
            otpVerified = true;
            otpRequested = true;
            updateOtpUI();
            showToast('success', 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰');
          }
          updateNextAvailability();
        })
        .catch(err2 => {
          console.warn('OTP verify error', err2);
          if (err) {
            err.style.display = 'block';
            err.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯.';
          }
        });
    }

    /* âœ… Validation per step */

    function isStepValid(idx) {
      const pageId = orderedPages[idx];

      if (pageId === 'page1') return true;

      if (pageId === 'page2') {
        const area = $('#area').val() || '';
        const cat = $('#serviceCat').val() || '';
        const srv = $('#service').val() || '';

        toggleFieldError('area', !area);
        toggleFieldError('serviceCat', !cat);
        toggleFieldError('service', !srv);

        return !!(area && cat && srv);
      }

      if (pageId === 'page3') {
        const dateVal = $('#date').val() || '';
        toggleFieldError('date', !dateVal);
        if (!dateVal || !selectedTime) return false;
        return true;
      }

      if (pageId === 'page4') {
        const name = ($('#name').val() || '').trim();
        const mobile = ($('#mobile').val() || '').trim();

        toggleFieldError('name', !name);
        toggleFieldError('mobile', !mobile);

        if (!name || !mobile) return false;

        if (OTP_ENABLED && !otpVerified) {
          const err = document.getElementById('err-otp');
          if (err) {
            err.style.display = 'block';
            err.textContent = 'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.';
          }
          return false;
        }
        return true;
      }

      if (pageId === 'page5') {
        const pm = nForm.paymentMethod || '';
        const el = document.getElementById('err-pay');
        if (!pm) {
          if (el) el.style.display = 'block';
          return false;
        } else {
          if (el) el.style.display = 'none';
        }
        return true;
      }

      if (pageId === 'page6') {
        const ok = !!positionUrl;
        const el = document.getElementById('err-map');
        if (!ok) { if (el) el.style.display = 'block'; }
        else { if (el) el.style.display = 'none'; }
        return ok;
      }

      return true;
    }

    function toggleFieldError(fieldBase, show) {
      const group = document.getElementById(fieldBase)?.closest('.col') || document.getElementById(fieldBase)?.closest('.mb-3') || null;
      if (group) {
        group.classList.toggle('has-error', !!show);
      }
      const err = document.getElementById(`err-${fieldBase}`);
      if (err) {
        err.style.display = show ? 'block' : 'none';
      }
    }

    function updateNextAvailability() {
      const btn = document.getElementById('footer-next');
      if (!btn) return;
      const idx = getActiveIndex();

      // Ù„Ùˆ Ø¢Ø®Ø± Ø®Ø·ÙˆØ© ÙØ¹Ù„Ù‹Ø§ (Ù‚Ø¨Ù„ ØµÙØ­Ø© Ø§Ù„Ø´ÙƒØ±)ØŒ ÙŠØ¸Ù„ Ø§Ù„Ø²Ø± Ù…ÙØ¹Ù‘ÙÙ„ Ø¥Ø°Ø§ valid
      const valid = isStepValid(idx);
      btn.disabled = !valid;
      btn.classList.toggle('disabled', !valid);
    }

    /* ğŸš€ Navigation + Submit */

    function goNext() {
      const idx = getActiveIndex();
      if (!isStepValid(idx)) {
        updateNextAvailability();
        return;
      }

      if (orderedPages[idx] === 'page6') {
        // Ø§Ù„Ø­ÙØ¸ / Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        submitReservation();
        return;
      }

      if (idx < orderedPages.length - 1) {
        showPage(idx + 1);
      }
    }

    function goPrev() {
      const idx = getActiveIndex();
      if (idx > 0) {
        showPage(idx - 1);
      }
    }

    function buildReservationPayload() {
      return {
        appId: APP_ID,
        date: nForm.date,
        time: nForm.time,
        area: $('#area').val() || '',
        areaName: $('#area').find(':selected').text() || '',
        serviceCat: $('#serviceCat').val() || '',
        serviceCatName: $('#serviceCat').find(':selected').text() || '',
        service: $('#service').val() || '',
        serviceName: $('#service').find(':selected').text() || '',
        serviceCount: getCarCount(),
        customerName: ($('#name').val() || '').trim(),
        customerMobile: ($('#mobile').val() || '').trim(),
        carBrand: $('#carBrand').val() || '',
        carBrandName: $('#carBrand').find(':selected').text() || '',
        carName: ($('#carName').val() || '').trim(),
        plateNumber: ($('#plateNumber').val() || '').trim(),
        paymentMethod: nForm.paymentMethod || '',
        urlLocation: positionUrl || '',
        locationDescription: ($('#locationDescription').val() || '').trim(),
        additionalServicesIds: nForm.additionalServicesIds || [],
        additionalServicesLabels: nForm.additionalServicesLabels || [],
        couponCode: nForm.couponCode || '',
        totalBeforeDiscount: getOrderSubtotal(),
        couponDiscountAmount,
        totalAfterDiscount: Math.max(0, getOrderSubtotal() - couponDiscountAmount)
      };
    }

    async function submitReservation() {
      if (isSubmitting) return;
      isSubmitting = true;

      const footerWait = document.getElementById('footer-wait');
      const nextBtn = document.getElementById('footer-next');
      if (footerWait) footerWait.classList.add('show');
      if (nextBtn) nextBtn.disabled = true;

      const payload = buildReservationPayload();

      try {
        const res = await postReservation(payload);
        if (!res.ok) {
          console.warn('Reservation error', res);
          showToast('error', 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
          return;
        }

        const tsArea = document.getElementById('ts-area');
        const tsService = document.getElementById('ts-service');
        const tsDt = document.getElementById('ts-dt');
        const tsPay = document.getElementById('ts-pay');

        if (tsArea) tsArea.textContent = payload.areaName || 'â€”';
        if (tsService) tsService.textContent = payload.serviceName || 'â€”';

        if (tsDt) {
          const d = payload.date ? DateTime.fromISO(payload.date).toFormat('d LLL yyyy') : '';
          tsDt.textContent = (d && payload.time) ? `${d} â€¢ ${payload.time}` : (d || payload.time || 'â€”');
        }
        if (tsPay) tsPay.textContent = payload.paymentMethod || 'â€”';

        // Ø±Ø§Ø¨Ø· Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨
        const shareEl = document.getElementById('ts-whatsapp');
        if (shareEl) {
          const txt = `Ø·Ù„Ø¨ ØºØ³ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ù…Ù†Ø·Ù‚Ø©: ${payload.areaName}\nØ§Ù„Ø®Ø¯Ù…Ø©: ${payload.serviceName}\nØ§Ù„ÙˆÙ‚Øª: ${payload.date} - ${payload.time}\n`;
          const encoded = encodeURIComponent(txt);
          shareEl.href = `https://wa.me/?text=${encoded}`;
        }

        // ØµÙØ­Ø© Ø§Ù„Ø´ÙƒØ±
        const idxDone = orderedPages.indexOf('page7');
        if (idxDone > -1) showPage(idxDone);
      } catch (err) {
        console.warn('Reservation error', err);
        showToast('error', 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      } finally {
        isSubmitting = false;
        if (footerWait) footerWait.classList.remove('show');
        if (nextBtn) {
          nextBtn.disabled = false;
          updateNextAvailability();
        }
      }
    }

    /* ğŸ“ Google Map */

    let map, marker, searchBox;

    function setMarkerPosition(latLng) {
      if (!map || !marker) return;
      marker.setPosition(latLng);
      map.panTo(latLng);

      const lat = latLng.lat();
      const lng = latLng.lng();
      positionUrl = `https://www.google.com/maps?q=${lat},${lng}`;
      nForm.urlLocation = positionUrl;

      const err = document.getElementById('err-map');
      if (err) err.style.display = 'none';

      renderSummary('page6');
      updateNextAvailability();
    }

    function initMap() {
      const mapEl = document.getElementById('googleMap');
      if (!mapEl) return;

      const center = { lat: 24.7136, lng: 46.6753 }; // Riyadh default
      map = new google.maps.Map(mapEl, {
        center,
        zoom: 12,
        disableDefaultUI: false
      });

      marker = new google.maps.Marker({
        map,
        position: center,
        draggable: true
      });

      google.maps.event.addListener(map, 'click', function (e) {
        setMarkerPosition(e.latLng);
      });

      google.maps.event.addListener(marker, 'dragend', function (e) {
        setMarkerPosition(e.latLng);
      });

      const input = document.getElementById('mapSearch');
      if (input) {
        searchBox = new google.maps.places.SearchBox(input);
        map.addListener('bounds_changed', () => {
          searchBox.setBounds(map.getBounds());
        });
        searchBox.addListener('places_changed', () => {
          const places = searchBox.getPlaces();
          if (!places || !places.length) return;
          const place = places[0];
          if (!place.geometry || !place.geometry.location) return;
          setMarkerPosition(place.geometry.location);
        });
      }

      const btnMyLoc = document.getElementById('show-my-location');
      if (btnMyLoc && navigator.geolocation) {
        btnMyLoc.addEventListener('click', () => {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
              setMarkerPosition(ll);
              map.setZoom(15);
            },
            err => {
              console.warn('geolocation error', err);
              showToast('error', 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.');
            }
          );
        });
      }

      window._map = map;
      window._marker = marker;
    }
    window.initMap = initMap;

    /* ğŸ“± PWA install */

    let deferredPrompt = null;

    function setupPwaInstallButtons() {
      const bubbleBtn = document.getElementById('installPwaBtn');
      const footerBtn = document.getElementById('footer-install-btn');

      function showButtons() {
        if (bubbleBtn) bubbleBtn.style.display = 'block';
        if (footerBtn) footerBtn.style.display = 'block';
      }

      function hideButtons() {
        if (bubbleBtn) bubbleBtn.style.display = 'none';
        if (footerBtn) footerBtn.style.display = 'none';
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showButtons();
      });

      async function handleInstallClick() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          hideButtons();
          deferredPrompt = null;
        }
      }

      if (bubbleBtn) bubbleBtn.addEventListener('click', handleInstallClick);
      if (footerBtn) footerBtn.addEventListener('click', handleInstallClick);

      window.addEventListener('appinstalled', () => {
        hideButtons();
        deferredPrompt = null;
      });

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(err => {
          console.warn('SW register error', err);
        });
      }
    }

    /* ğŸ§· Static demo data (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨ØªØ­Ù…ÙŠÙ„ Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Google Sheets / API) */

    function initStaticAreasAndServices() {
      const $area = $('#area');
      const $cat = $('#serviceCat');
      const $srv = $('#service');

      if (!$area.children().length) {
        $area.append('<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>');
        $area.append('<option value="riyadh">Ø§Ù„Ø±ÙŠØ§Ø¶</option>');
        $area.append('<option value="dam">Ø§Ù„Ø¯Ù…Ø§Ù…</option>');
      }

      if (!$cat.children().length) {
        $cat.append('<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>');
        $cat.append('<option value="basic">ØºØ³ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ</option>');
        $cat.append('<option value="premium">ØºØ³ÙŠÙ„ ÙØ§Ø®Ø±</option>');
      }

      function refreshServices() {
        const catVal = $cat.val() || '';
        $srv.empty();
        $srv.append('<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©</option>');
        if (catVal === 'basic') {
          $srv.append('<option value="basic-inout" data-price="80">ØºØ³ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ Ø¯Ø§Ø®Ù„ÙŠ + Ø®Ø§Ø±Ø¬ÙŠ</option>');
          $srv.append('<option value="basic-out" data-price="50">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø·</option>');
        } else if (catVal === 'premium') {
          $srv.append('<option value="prem-full" data-price="150">ØºØ³ÙŠÙ„ ÙØ§Ø®Ø± ÙƒØ§Ù…Ù„</option>');
          $srv.append('<option value="prem-detail" data-price="220">ØªÙ„Ù…ÙŠØ¹ ÙˆØ¯ÙŠØªÙŠÙ„Ù†Ø¬</option>');
        }
      }

      refreshServices();

      $cat.on('change', () => {
        refreshServices();
        baseServicePrice = 0;
        $('#serviceDetails').text('Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‡Ù†Ø§.');
        $('#servicePrice').text('â€”');
        updateFooterTotal();
        renderSummary('page2');
        loadAdditionalServices();
      });

      $srv.on('change', () => {
        const opt = $srv.find(':selected');
        const price = Number(opt.data('price') || 0);
        baseServicePrice = price;

        const desc = getServiceDescription({
          TS_service_descriptionAR: opt.text(),
          TS_service_descriptionEN: opt.text()
        });
        $('#serviceDetails').text(desc || opt.text() || 'â€”');
        $('#servicePrice').text(formatServicePrice(price));

        updateFooterTotal();
        renderSummary('page2');
        loadAdditionalServices();
      });

      $area.on('change', () => {
        renderSummary('page2');
        loadAdditionalServices();
      });
    }

    function initCarBrands() {
      const $brand = $('#carBrand');
      if (!$brand.length) return;
      if ($brand.children().length) return;

      $brand.append('<option value="">Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>');
      const brands = ['ØªÙˆÙŠÙˆØªØ§', 'Ù„ÙƒØ²Ø³', 'Ù…Ø±Ø³ÙŠØ¯Ø³', 'Ø¨ÙŠ Ø¥Ù… Ø¯Ø¨Ù„ÙŠÙˆ', 'Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ', 'ÙƒÙŠØ§', 'ÙÙˆØ±Ø¯', 'Ù†ÙŠØ³Ø§Ù†', 'Ø´ÙŠÙØ±ÙˆÙ„ÙŠÙ‡', 'Ù‡ÙˆÙ†Ø¯Ø§', 'Ø£Ø®Ø±Ù‰'];
      brands.forEach(b => {
        $brand.append(`<option value="${b}">${b}</option>`);
      });
    }

    /* ğŸ§­ Init on ready */

    $(function () {
      // Select2
      $('#area, #serviceCat, #service, #carBrand').select2({
        width: '100%',
        theme: 'bootstrap-5',
        dir: $('html').attr('dir') || 'rtl'
      });

      // intlTelInput
      const mobileInput = document.querySelector('#mobile');
      if (mobileInput) {
        itiPhone = window.intlTelInput(mobileInput, {
          initialCountry: 'sa',
          preferredCountries: ['sa', 'qa', 'ae', 'kw', 'bh', 'om'],
          separateDialCode: true,
          utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@24.4.0/build/js/utils.js'
        });
        mobileInput.addEventListener('blur', updateOtpUI);
        mobileInput.addEventListener('input', updateOtpUI);
      }

      // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… + Ø§Ù„ØºØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
      const today = DateTime.now().toISODate();
      $('#date').val(today);
      fetchTimesForSelectedDate();

      $('#date').on('change', () => {
        fetchTimesForSelectedDate();
        renderSummary('page3');
      });

      $('#timeFilter').on('change', onTimeFilterChange);

      $('#serviceCount').on('change', () => {
        updateAdditionalServicesTotal();
        renderSummary('page2');
      });

      $('#plateNumber').on('input', updatePlateHint);

      $('#name').on('input', () => {
        renderSummary('page4');
        updateNextAvailability();
      });

      $('#mobile').on('input', () => {
        renderSummary('page4');
        updateNextAvailability();
      });

      $('#btnSendOtp').on('click', sendOtp);
      $('#btnVerifyOtp').on('click', verifyOtp);

      $('#applyCouponBtn').on('click', validateCouponAndApply);
      $('#couponCode').on('keyup', (e) => {
        if (e.key === 'Enter') validateCouponAndApply();
      });

      $('#footer-next').on('click', goNext);
      $('#footer-prev').on('click', goPrev);

      $('#rebook').on('click', () => {
        const idx = orderedPages.indexOf('page2');
        if (idx > -1) showPage(idx);
      });

      $('#btnShowOffers').on('click', openOffersModal);
      document.querySelectorAll('.offers-close, #offersModal .offers-backdrop').forEach(el => {
        el.addEventListener('click', closeOffersModal);
      });

      document.querySelectorAll('#offersFilters .offers-filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const type = chip.dataset.type;
          if (!type || type === 'all') {
            chip.classList.toggle('active');
            const on = chip.classList.contains('active');
            offersFilterState.image = on;
            offersFilterState.text = on;
            offersFilterState.coupon = on;
          } else {
            chip.classList.toggle('active');
            offersFilterState[type] = chip.classList.contains('active');
          }
          renderOffersList();
        });
      });

      initStaticAreasAndServices();
      initCarBrands();
      loadPaymentMethods();
      setupPwaInstallButtons();
      updateFooterTotal();
      renderSummary('page1');
      updateNextAvailability();

      // ØªØ´ØºÙŠÙ„ deck Ø§Ù„ØªØ±Ø­ÙŠØ¨
      startWelcomeDeck();
    });
  </script>

  <!-- ğŸ”‘ Google Maps (Ø¶Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ù‡Ù†Ø§) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBHLoO038vsCovHN-SLUgAXqexlA2v0_4&libraries=places&callback=initMap"></script>
</body>
</html>
